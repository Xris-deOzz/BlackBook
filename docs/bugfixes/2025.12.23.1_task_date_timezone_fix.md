# Bug Fix: Task Date Timezone Display Issue

**Version:** 2025.12.23.1
**Date:** December 23, 2025
**Commit:** 8cc1d4b

## Summary

Fixed two issues with Google Tasks integration:
1. Tasks with dates (but no time) displayed as the previous day
2. Task list didn't auto-refresh after creating a new task

---

## Issue 1: Task Date Timezone Bug

### Symptoms
- User creates a task due Dec 23 with no time
- Task saves correctly to Google Tasks (shows "Today" on Dec 23)
- BlackBook displays the task as Dec 22

### Root Cause
Google Tasks stores date-only tasks as midnight UTC (`2025-12-23T00:00:00.000Z`). When BlackBook converted this to NYC timezone (UTC-5), midnight UTC became 7pm on December **22nd**.

### Solution
Two-part fix (defense in depth):

**Read Side:** Detect date-only tasks (midnight UTC) and extract the date directly without timezone conversion.

**Write Side:** Save date-only tasks at noon local time instead of midnight UTC, ensuring the correct date survives any timezone conversion.

### Files Modified
- `app/services/tasks_service.py`
  - `get_tasks_by_list()` - Fixed date parsing for task list display
  - `get_task()` - Fixed date parsing for single task retrieval
  - `create_task()` - Save date-only tasks at noon local time
  - `update_task()` - Save date-only tasks at noon local time

### Code Changes

**Reading tasks (get_tasks_by_list, get_task):**
```python
# Detect date-only tasks (midnight UTC)
is_date_only = (due_dt.hour == 0 and due_dt.minute == 0 and due_dt.second == 0)

if is_date_only:
    # Extract date directly from UTC to avoid timezone shift
    due_date = due_dt.date()
else:
    # Task has specific time - convert to local timezone
    due_local = due_dt.astimezone(local_tz)
    due_date = due_local.date()
```

**Writing tasks (create_task, update_task):**
```python
if due_date and not due_time:
    # Use noon local time to avoid timezone day-shift issues
    local_tz = ZoneInfo("America/New_York")
    due_dt = datetime.strptime(f"{due_date} 12:00", "%Y-%m-%d %H:%M")
    due_dt = due_dt.replace(tzinfo=local_tz)
    body["due"] = due_dt.astimezone(timezone.utc).strftime("%Y-%m-%dT%H:%M:%S.000Z")
```

---

## Issue 2: Task List Auto-Refresh

### Symptoms
- User creates a new task via the modal
- Modal shows success state
- Task list behind modal doesn't update until page refresh

### Root Cause
The `refreshTaskViews()` function was using shorthand htmx.ajax() syntax that wasn't consistently triggering updates.

### Solution
Updated `refreshTaskViews()` with explicit htmx options and fallback selectors.

### Files Modified
- `app/templates/dashboard/_add_task_modal.html`

### Code Changes
```javascript
function refreshTaskViews() {
    const currentView = window.dashboardCurrentView || 'week';

    const tasksPanel = document.getElementById('tasks-panel-content');
    if (tasksPanel) {
        htmx.ajax('GET', `/dashboard/tasks-panel?view=${currentView}`,
                  {target: '#tasks-panel-content', swap: 'innerHTML'});
    }
    // ... additional refresh targets
}
```

---

## Testing Performed

1. ✅ Created task with date only (Dec 23) - displays as Dec 23
2. ✅ Created task with date and time (Dec 23 2pm) - displays correctly
3. ✅ Verified task appears correctly in Google Tasks
4. ✅ Task list refreshes automatically after creation
5. ✅ Existing tasks display with correct dates

---

## Deployment
```bash
git commit -m "Fix task date display timezone bug - handle date-only tasks correctly"
git push origin main

ssh xrisnyc@bearcave
cd /volume1/docker/blackbook
git pull origin main
sudo docker-compose -f docker-compose.prod.yml down
sudo docker-compose -f docker-compose.prod.yml up --build -d
```

---

## Related

- Google Tasks API stores dates as RFC 3339 format
- BlackBook uses `America/New_York` timezone for display
- Similar timezone handling exists in calendar integration
