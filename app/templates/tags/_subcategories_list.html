<!-- Tag Subcategories Management Partial -->
<div class="space-y-4">
    {% if subcategories %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-blackbook-200">
            <thead class="bg-blackbook-50">
                <tr>
                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-blackbook-500 uppercase tracking-wider w-8">
                        <svg class="w-4 h-4 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Drag to reorder">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                        </svg>
                    </th>
                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-blackbook-500 uppercase tracking-wider">Subcategory</th>
                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-blackbook-500 uppercase tracking-wider">Default Color</th>
                    <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-blackbook-500 uppercase tracking-wider">Tags</th>
                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-blackbook-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="subcategory-sortable" class="bg-white divide-y divide-blackbook-200">
                {% for subcat in subcategories %}
                <tr class="hover:bg-blackbook-50 subcategory-row" data-id="{{ subcat.id }}">
                    <td class="px-4 py-3 whitespace-nowrap cursor-move drag-handle">
                        <svg class="w-4 h-4 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                        </svg>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="text-sm font-medium text-blackbook-900">{{ subcat.name }}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <input type="color" 
                                   value="{{ subcat.default_color }}"
                                   class="w-8 h-8 rounded border border-blackbook-300 cursor-pointer"
                                   onchange="updateSubcategoryColor('{{ subcat.id }}', this.value)"
                                   title="Click to change color">
                            <span class="text-xs font-mono text-blackbook-600">{{ subcat.default_color }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blackbook-100 text-blackbook-800">
                            {{ subcat_counts.get(subcat.name, 0) }}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm">
                        <div class="flex justify-end gap-2">
                            <button type="button"
                                    onclick="applyColorToAllTags('{{ subcat.id }}', '{{ subcat.name }}', {{ subcat_counts.get(subcat.name, 0) }})"
                                    class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-700 bg-blue-50 rounded hover:bg-blue-100 transition-colors"
                                    title="Apply this color to all tags in this subcategory">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                                </svg>
                                Apply to All
                            </button>
                            <button type="button"
                                    onclick="deleteSubcategory('{{ subcat.id }}', '{{ subcat.name }}')"
                                    class="text-red-600 hover:text-red-900 p-1"
                                    title="Delete subcategory (tags will keep their subcategory name)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-6 text-blackbook-500">
        <p class="text-sm">No subcategories defined yet. Add one below.</p>
    </div>
    {% endif %}

    <!-- Add New Subcategory Form -->
    <div class="mt-4 p-4 bg-blackbook-50 rounded-lg">
        <h4 class="text-sm font-medium text-blackbook-700 mb-3">Add New Subcategory</h4>
        <form id="add-subcategory-form" class="flex items-end gap-3">
            <div class="flex-1">
                <label for="new-subcat-name" class="block text-xs text-blackbook-500 mb-1">Name</label>
                <input type="text" 
                       id="new-subcat-name" 
                       name="name"
                       required
                       maxlength="50"
                       placeholder="e.g., Family, Industry Contacts"
                       class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 text-sm">
            </div>
            <div class="w-32">
                <label for="new-subcat-color" class="block text-xs text-blackbook-500 mb-1">Color</label>
                <div class="flex items-center gap-2">
                    <input type="color" 
                           id="new-subcat-color" 
                           name="default_color"
                           value="#6b7280"
                           class="w-10 h-9 rounded border border-blackbook-300 cursor-pointer">
                    <input type="text" 
                           id="new-subcat-color-text"
                           value="#6b7280"
                           pattern="^#[0-9A-Fa-f]{6}$"
                           class="w-20 px-2 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 text-xs font-mono">
                </div>
            </div>
            <button type="submit"
                    class="px-4 py-2 bg-blackbook-600 text-white font-medium rounded-md hover:bg-blackbook-700 focus:outline-none focus:ring-2 focus:ring-blackbook-500 text-sm">
                Add
            </button>
        </form>
    </div>

    <!-- Status message -->
    <div id="subcategory-status" class="hidden mt-2 p-3 rounded-md text-sm"></div>
</div>

<script>
// Sync color picker with text input for new subcategory form
document.addEventListener('DOMContentLoaded', function() {
    const colorPicker = document.getElementById('new-subcat-color');
    const colorText = document.getElementById('new-subcat-color-text');
    
    if (colorPicker && colorText) {
        colorPicker.addEventListener('input', function() {
            colorText.value = this.value.toUpperCase();
        });
        
        colorText.addEventListener('input', function() {
            if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                colorPicker.value = this.value;
            }
        });
    }
    
    // Handle form submission
    const form = document.getElementById('add-subcategory-form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/tags/subcategories', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('Subcategory added successfully!', 'success');
                    // Reload the page to show the new subcategory
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    showStatus(data.detail || 'Failed to add subcategory', 'error');
                }
            } catch (error) {
                showStatus('Error adding subcategory: ' + error.message, 'error');
            }
        });
    }
    
    // Initialize drag and drop for reordering
    initSortable();
});

function showStatus(message, type) {
    const status = document.getElementById('subcategory-status');
    status.textContent = message;
    status.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');
    
    if (type === 'success') {
        status.classList.add('bg-green-50', 'text-green-700');
    } else {
        status.classList.add('bg-red-50', 'text-red-700');
    }
    
    setTimeout(() => status.classList.add('hidden'), 3000);
}

async function updateSubcategoryColor(subcatId, newColor) {
    try {
        const formData = new FormData();
        formData.append('default_color', newColor);
        
        const response = await fetch(`/tags/subcategories/${subcatId}`, {
            method: 'PUT',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showStatus(`Color updated to ${newColor}`, 'success');
        } else {
            showStatus(data.detail || 'Failed to update color', 'error');
        }
    } catch (error) {
        showStatus('Error updating color: ' + error.message, 'error');
    }
}

async function applyColorToAllTags(subcatId, subcatName, tagCount) {
    if (tagCount === 0) {
        showStatus('No tags in this subcategory to update', 'error');
        return;
    }
    
    if (!confirm(`Apply the default color to all ${tagCount} tags in "${subcatName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/tags/subcategories/${subcatId}/apply-color`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showStatus(`Updated ${data.updated_count} tags to ${data.color}`, 'success');
            // Reload to show updated colors
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showStatus(data.detail || 'Failed to apply color', 'error');
        }
    } catch (error) {
        showStatus('Error applying color: ' + error.message, 'error');
    }
}

async function deleteSubcategory(subcatId, subcatName) {
    if (!confirm(`Delete subcategory "${subcatName}"?\n\nTags using this subcategory will keep their subcategory name.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/tags/subcategories/${subcatId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showStatus(`Deleted subcategory "${data.deleted}"`, 'success');
            // Remove the row from the table
            const row = document.querySelector(`tr[data-id="${subcatId}"]`);
            if (row) row.remove();
        } else {
            showStatus(data.detail || 'Failed to delete subcategory', 'error');
        }
    } catch (error) {
        showStatus('Error deleting subcategory: ' + error.message, 'error');
    }
}

function initSortable() {
    const tbody = document.getElementById('subcategory-sortable');
    if (!tbody) return;
    
    let draggedRow = null;
    
    tbody.querySelectorAll('.subcategory-row').forEach(row => {
        const handle = row.querySelector('.drag-handle');
        
        handle.addEventListener('mousedown', function(e) {
            draggedRow = row;
            row.classList.add('opacity-50');
        });
    });
    
    tbody.addEventListener('dragover', function(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(tbody, e.clientY);
        if (draggedRow && afterElement) {
            tbody.insertBefore(draggedRow, afterElement);
        } else if (draggedRow) {
            tbody.appendChild(draggedRow);
        }
    });
    
    document.addEventListener('mouseup', async function() {
        if (draggedRow) {
            draggedRow.classList.remove('opacity-50');
            
            // Get new order and save it
            const rows = tbody.querySelectorAll('.subcategory-row');
            const order = Array.from(rows).map(r => r.dataset.id);
            
            try {
                const response = await fetch('/tags/subcategories/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order })
                });
                
                const data = await response.json();
                if (data.success) {
                    showStatus('Order saved', 'success');
                }
            } catch (error) {
                console.error('Error saving order:', error);
            }
            
            draggedRow = null;
        }
    });
    
    // Make rows draggable
    tbody.querySelectorAll('.subcategory-row').forEach(row => {
        row.setAttribute('draggable', 'true');
        
        row.addEventListener('dragstart', function(e) {
            draggedRow = this;
            this.classList.add('opacity-50');
        });
        
        row.addEventListener('dragend', function() {
            this.classList.remove('opacity-50');
        });
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.subcategory-row:not(.opacity-50)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
</script>
