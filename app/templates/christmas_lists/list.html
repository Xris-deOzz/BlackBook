{% extends "base.html" %}

{% block breadcrumb %}
<nav class="bg-white border-b border-blackbook-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <ol class="flex items-center space-x-2 text-sm">
            <li>
                <a href="/" class="text-blackbook-500 hover:text-blackbook-700">Home</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li>
                <a href="/christmas-lists" class="text-blackbook-500 hover:text-blackbook-700">Christmas Lists</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li class="text-blackbook-900 font-medium">{{ list_name }} List</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            {% if list_type == 'polish' %}
            <span class="text-4xl">ðŸ‡µðŸ‡±</span>
            {% else %}
            <span class="text-4xl">ðŸŽ…</span>
            {% endif %}
            <div>
                <h1 class="text-2xl font-bold text-blackbook-900">{{ list_name }} Christmas List</h1>
                <p class="text-sm text-blackbook-500">
                    {{ member_count }} people, {{ email_count }} with email
                </p>
            </div>
        </div>
        <div class="flex gap-2">
            <a href="/christmas-lists/export/{{ list_type }}"
               class="inline-flex items-center px-4 py-2 bg-blackbook-100 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Export CSV
            </a>
            {% if email_count > 0 %}
            <button type="button" onclick="emailAll()"
                    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Email All ({{ email_count }})
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Members Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div id="table-container">
            {% include "christmas_lists/_table.html" %}
        </div>
    </div>

    <!-- Back Link -->
    <div>
        <a href="/christmas-lists" class="inline-flex items-center text-blackbook-600 hover:text-blackbook-800">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to Christmas Lists
        </a>
    </div>
</div>

<script>
function emailAll() {
    const emails = [];
    document.querySelectorAll('[data-email]').forEach(el => {
        const email = el.dataset.email;
        if (email) emails.push(email);
    });

    if (emails.length === 0) {
        alert('No email addresses found');
        return;
    }

    // Open Gmail compose with BCC
    const bcc = emails.join(',');
    window.open(`https://mail.google.com/mail/?view=cm&fs=1&bcc=${encodeURIComponent(bcc)}`, '_blank');
}

async function removeFromList(personId, listType) {
    if (!confirm('Remove this person from the Christmas list?')) {
        return;
    }

    try {
        const response = await fetch('/christmas-lists/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                person_id: personId,
                list_type: listType
            })
        });

        if (response.ok) {
            // Refresh the table
            htmx.ajax('GET', `/christmas-lists/table/${listType}`, '#table-container');
        } else {
            const data = await response.json();
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error removing from list:', error);
        alert('Error removing from list');
    }
}
</script>
{% endblock %}
