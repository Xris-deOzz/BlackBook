{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-blackbook-50">
    <!-- Header - full width -->
    <div class="bg-white border-b border-blackbook-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-blackbook-900">Email</h1>
                {% if unread_inbox > 0 %}
                <span class="bg-blue-600 text-white text-xs font-medium px-2 py-0.5 rounded-full">
                    {{ unread_inbox }} unread
                </span>
                {% endif %}
            </div>

            <!-- Sync button -->
            <button hx-post="/emails/sync"
                    hx-target="#sync-status"
                    hx-swap="innerHTML"
                    class="inline-flex items-center px-3 py-1.5 bg-blackbook-100 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-200 transition-colors">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Sync Now
            </button>
        </div>
    </div>

    <div class="flex h-[calc(100vh-130px)]">
        <!-- Sidebar - fixed width, scrollable -->
        <div class="w-64 flex-shrink-0 bg-white border-r border-blackbook-200 overflow-y-auto">
            <!-- Sync Status - at the top for visibility -->
            <div id="sync-status" class="p-3 bg-blackbook-50 border-b border-blackbook-200">
                {% include "emails/_sync_status.html" %}
            </div>

            <!-- Folders -->
            {% set other_folder_selected = folder in ['sent', 'drafts', 'spam', 'trash', 'all'] %}
            <div class="p-4" x-data="{ foldersOpen: {{ 'true' if other_folder_selected else 'false' }} }">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold text-blackbook-500 uppercase tracking-wider">Folders</h3>
                    <button @click="foldersOpen = !foldersOpen" class="p-0.5 hover:bg-blackbook-100 rounded transition-colors" type="button">
                        <svg class="w-3.5 h-3.5 text-blackbook-400 transition-transform" :class="{ 'rotate-180': foldersOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                </div>
                <nav class="space-y-1">
                    <!-- Inbox - always visible -->
                    <a href="/emails?folder=inbox"
                       class="flex items-center justify-between px-3 py-2 rounded-md {% if folder == 'inbox' %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %}">
                        <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                            </svg>
                            Inbox
                        </span>
                        {% if unread_inbox > 0 %}
                        <span class="bg-blue-600 text-white text-xs font-medium px-2 py-0.5 rounded-full">{{ unread_inbox }}</span>
                        {% endif %}
                    </a>
                    <!-- Other folders - collapsible -->
                    <div x-show="foldersOpen" x-collapse class="space-y-1">
                        <a href="/emails?folder=sent"
                           class="flex items-center px-3 py-2 rounded-md {% if folder == 'sent' %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %}">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                            Sent
                        </a>
                        <a href="/emails?folder=drafts"
                           class="flex items-center px-3 py-2 rounded-md {% if folder == 'drafts' %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %}">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Drafts
                        </a>
                        <a href="/emails?folder=spam"
                           class="flex items-center px-3 py-2 rounded-md {% if folder == 'spam' %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %}">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                            </svg>
                            Spam
                        </a>
                        <a href="/emails?folder=trash"
                           class="flex items-center px-3 py-2 rounded-md {% if folder == 'trash' %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %}">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Trash
                        </a>
                        <a href="/emails?folder=all"
                           class="flex items-center px-3 py-2 rounded-md {% if folder == 'all' %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %}">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            All Mail
                        </a>
                    </div>
                </nav>
            </div>

            <!-- Gmail Labels -->
            {% if gmail_labels %}
            <div class="p-4 border-t border-blackbook-200" x-data="{ labelsOpen: {{ 'true' if label else 'false' }} }">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold text-blackbook-500 uppercase tracking-wider">Labels</h3>
                    <button @click="labelsOpen = !labelsOpen" class="p-0.5 hover:bg-blackbook-100 rounded transition-colors" type="button">
                        <svg class="w-3.5 h-3.5 text-blackbook-400 transition-transform" :class="{ 'rotate-180': labelsOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                </div>
                <nav x-show="labelsOpen" x-collapse class="space-y-1">
                    {% for lbl in gmail_labels %}
                        {% if lbl.children %}
                        <!-- Parent label with children (collapsible) -->
                        <!-- Check if parent or any child is selected to auto-expand -->
                        {% set has_selected_child = label == lbl.name or label in lbl.children|map(attribute='name')|list %}
                        <div x-data="{ open: {{ 'true' if has_selected_child else 'false' }} }" class="space-y-0.5 group/parent">
                            <div class="flex items-center">
                                <!-- Expand/collapse toggle -->
                                <button @click="open = !open"
                                        class="p-1 hover:bg-blackbook-100 rounded transition-colors"
                                        type="button">
                                    <svg class="w-3 h-3 text-blackbook-500 transition-transform"
                                         :class="{ 'rotate-90': open }"
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </button>
                                <!-- Parent label (clickable if it has its own label ID) -->
                                {% if lbl.name %}
                                <a href="/emails?folder=all&account_id={{ account_id }}&label={{ lbl.name }}"
                                   class="flex-1 flex items-center px-2 py-1.5 rounded-md text-sm {% if label == lbl.name %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %} truncate"
                                   title="{{ lbl.display_name }}">
                                    <svg class="w-4 h-4 mr-2 flex-shrink-0 {% if label == lbl.name %}text-white{% else %}text-blackbook-400{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                    <span class="truncate font-medium">{{ lbl.display_name }}</span>
                                </a>
                                <!-- Sync button for parent label -->
                                <button hx-post="/emails/sync-folder?folder=all&label={{ lbl.name }}&account_id={{ account_id }}"
                                        hx-target="#sync-status"
                                        hx-swap="innerHTML"
                                        class="p-1 ml-1 rounded opacity-0 group-hover/parent:opacity-100 hover:bg-blackbook-200 transition-all"
                                        title="Sync {{ lbl.display_name }}">
                                    <svg class="w-3.5 h-3.5 text-blackbook-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </button>
                                {% else %}
                                <span @click="open = !open"
                                      class="flex-1 flex items-center px-2 py-1.5 rounded-md text-sm text-blackbook-700 hover:bg-blackbook-100 cursor-pointer truncate"
                                      title="{{ lbl.display_name }}">
                                    <svg class="w-4 h-4 mr-2 flex-shrink-0 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                    <span class="truncate font-medium">{{ lbl.display_name }}</span>
                                </span>
                                {% endif %}
                            </div>
                            <!-- Child labels -->
                            <div x-show="open" x-collapse class="ml-4 pl-2 border-l border-blackbook-200 space-y-0.5">
                                {% for child in lbl.children %}
                                <div class="flex items-center group/child">
                                    <a href="/emails?folder=all&account_id={{ account_id }}&label={{ child.name }}"
                                       class="flex-1 flex items-center px-2 py-1 rounded-md text-sm {% if label == child.name %}bg-blue-600 text-white{% else %}text-blackbook-600 hover:bg-blackbook-100{% endif %} truncate"
                                       title="{{ child.display_name }}">
                                        <svg class="w-3.5 h-3.5 mr-2 flex-shrink-0 {% if label == child.name %}text-white{% else %}text-blackbook-400{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                        </svg>
                                        <span class="truncate">{{ child.display_name }}</span>
                                    </a>
                                    <!-- Sync button for child label -->
                                    <button hx-post="/emails/sync-folder?folder=all&label={{ child.name }}&account_id={{ account_id }}"
                                            hx-target="#sync-status"
                                            hx-swap="innerHTML"
                                            class="p-1 ml-1 rounded opacity-0 group-hover/child:opacity-100 hover:bg-blackbook-200 transition-all"
                                            title="Sync {{ child.display_name }}">
                                        <svg class="w-3 h-3 text-blackbook-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <!-- Standalone label (no children) -->
                        <div class="flex items-center group/label">
                            <a href="/emails?folder=all&account_id={{ account_id }}&label={{ lbl.name }}"
                               class="flex-1 flex items-center px-3 py-1.5 rounded-md text-sm {% if label == lbl.name %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %} truncate"
                               title="{{ lbl.display_name }}">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0 {% if label == lbl.name %}text-white{% else %}text-blackbook-400{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                </svg>
                                <span class="truncate">{{ lbl.display_name }}</span>
                            </a>
                            <!-- Sync button for standalone label -->
                            <button hx-post="/emails/sync-folder?folder=all&label={{ lbl.name }}&account_id={{ account_id }}"
                                    hx-target="#sync-status"
                                    hx-swap="innerHTML"
                                    class="p-1 ml-1 rounded opacity-0 group-hover/label:opacity-100 hover:bg-blackbook-200 transition-all"
                                    title="Sync {{ lbl.display_name }}">
                                <svg class="w-3.5 h-3.5 text-blackbook-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% if label %}
                    <a href="/emails?folder={{ folder }}&account_id={{ account_id }}"
                       class="flex items-center px-3 py-1.5 rounded-md text-sm text-blackbook-500 hover:bg-blackbook-100 mt-2">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Clear label filter
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}

            <!-- Accounts -->
            <div class="p-4 border-t border-blackbook-200">
                <h3 class="text-xs font-semibold text-blackbook-500 uppercase tracking-wider mb-2">Accounts</h3>
                <nav class="space-y-1">
                    <a href="/emails?folder={{ folder }}"
                       class="flex items-center px-3 py-2 rounded-md text-sm {% if not account_id %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %}">
                        All Accounts
                    </a>
                    {% for account in accounts %}
                    <a href="/emails?folder={{ folder }}&account_id={{ account.id }}"
                       class="flex items-center px-3 py-2 rounded-md text-sm {% if account_id == account.id|string %}bg-blue-600 text-white{% else %}text-blackbook-700 hover:bg-blackbook-100{% endif %} truncate"
                       title="{{ account.email }}">
                        {{ account.email }}
                    </a>
                    {% endfor %}
                </nav>
            </div>
        </div>

        <!-- Main Content - flexible width, scrollable -->
        <div class="flex-1 min-w-0 overflow-y-auto p-6">
            <!-- Search & Filters -->
            <div class="mb-4 flex items-center space-x-4">
                <div class="flex-1 relative">
                    <input type="text"
                           id="email-search"
                           placeholder="Search emails..."
                           value="{{ q }}"
                           class="w-full pl-10 pr-4 py-2 border border-blackbook-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           hx-get="/emails/table"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#email-list"
                           hx-include="[name='folder'], [name='account_id'], [name='label'], [name='unread_only']">
                    <svg class="absolute left-3 top-2.5 w-5 h-5 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>

                <!-- Hidden inputs for HTMX -->
                <input type="hidden" name="folder" value="{{ folder }}">
                <input type="hidden" name="account_id" value="{{ account_id }}">
                <input type="hidden" name="label" value="{{ label }}">

                <label class="flex items-center space-x-2 text-sm text-blackbook-700 flex-shrink-0">
                    <input type="checkbox"
                           name="unread_only"
                           {% if unread_only %}checked{% endif %}
                           class="rounded border-blackbook-300 text-blue-600 focus:ring-blue-500"
                           hx-get="/emails/table"
                           hx-trigger="change"
                           hx-target="#email-list"
                           hx-include="#email-search, [name='folder'], [name='account_id'], [name='label']">
                    <span>Unread only</span>
                </label>
            </div>

            <!-- Email List -->
            <div id="email-list" class="bg-blackbook-800 rounded-lg shadow overflow-hidden">
                {% include "emails/_email_list.html" %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
