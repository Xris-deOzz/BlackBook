{% if emails %}
<div class="divide-y divide-blackbook-600">
    {% for group in email_groups %}
    <!-- Date Group Header -->
    <div class="px-4 py-2 bg-blackbook-700 text-xs font-semibold text-blackbook-300 uppercase tracking-wider sticky top-0">
        {{ group.label }}
    </div>

    {% for email in group.emails %}
    <a href="/emails/{{ email.id }}"
       class="block px-4 py-3 transition-colors {% if not email.is_read %}bg-blackbook-700 hover:bg-blackbook-600{% else %}bg-blackbook-800 hover:bg-blackbook-700{% endif %}">
        <div class="flex items-start space-x-3">
            <!-- Unread indicator / Star -->
            <div class="flex-shrink-0 w-6 pt-1">
                {% if not email.is_read %}
                <span class="inline-block w-2 h-2 bg-blue-500 rounded-full"></span>
                {% elif email.is_starred %}
                <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                {% endif %}
            </div>

            <!-- Email Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-blackbook-100 truncate {% if not email.is_read %}font-semibold text-white{% endif %}">
                        {{ email.display_from }}
                    </p>
                    <p class="text-xs text-blackbook-400 flex-shrink-0 ml-2">
                        {% if email.internal_date %}
                            {{ email.internal_date.strftime('%b %d, %H:%M') }}
                        {% endif %}
                    </p>
                </div>
                <p class="text-sm text-blackbook-200 truncate {% if not email.is_read %}font-medium text-blackbook-100{% endif %}">
                    {{ email.subject or '(No subject)' }}
                </p>
                <p class="text-sm text-blackbook-400 truncate">
                    {{ email.snippet }}
                </p>

                <!-- Linked Contacts Badge -->
                {% if email.person_links %}
                <div class="mt-1 flex items-center space-x-1">
                    <svg class="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span class="text-xs text-blue-400">
                        {% for link in email.person_links[:2] %}
                            {{ link.person.full_name }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% if email.person_links|length > 2 %}
                            +{{ email.person_links|length - 2 }} more
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- Attachment indicator -->
                {% if email.has_attachments %}
                <div class="mt-1 flex items-center space-x-1">
                    <svg class="w-3 h-3 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                    <span class="text-xs text-blackbook-400">{{ email.attachment_count }} attachment{% if email.attachment_count != 1 %}s{% endif %}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </a>
    {% endfor %}
    {% endfor %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="px-4 py-3 border-t border-blackbook-600 bg-blackbook-800 flex items-center justify-between">
    <div class="text-sm text-blackbook-400">
        Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page, total_count]|min }} of {{ total_count }} emails
    </div>
    <div class="flex space-x-2">
        {% if page > 1 %}
        <a href="/emails?page={{ page - 1 }}&folder={{ folder }}&account_id={{ account_id }}&label={{ label }}&q={{ q }}&unread_only={{ unread_only }}"
           class="px-3 py-1 border border-blackbook-600 text-blackbook-200 rounded text-sm hover:bg-blackbook-700">
            Previous
        </a>
        {% endif %}
        {% if page < total_pages %}
        <a href="/emails?page={{ page + 1 }}&folder={{ folder }}&account_id={{ account_id }}&label={{ label }}&q={{ q }}&unread_only={{ unread_only }}"
           class="px-3 py-1 border border-blackbook-600 text-blackbook-200 rounded text-sm hover:bg-blackbook-700">
            Next
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<div class="p-12 text-center">
    <svg class="mx-auto h-12 w-12 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
    </svg>
    <h3 class="mt-4 text-lg font-medium text-blackbook-100">No emails found</h3>
    <p class="mt-2 text-sm text-blackbook-400">
        {% if q %}
            No emails match your search "{{ q }}".
        {% elif label %}
            This label hasn't been synced yet. Click below to fetch emails.
        {% elif folder and folder != 'inbox' and folder != 'all' %}
            This folder hasn't been synced yet. Click below to fetch emails.
        {% elif accounts %}
            Click "Sync Now" to fetch emails from your connected accounts.
        {% else %}
            Connect a Google account in Settings to see your emails.
        {% endif %}
    </p>
    {% if not accounts %}
    <a href="/settings#google-accounts" class="mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
        Connect Google Account
    </a>
    {% elif label and not q %}
    <div id="folder-sync-status">
        <button hx-post="/emails/sync-folder?label={{ label }}&account_id={{ account_id }}"
                hx-target="#folder-sync-status"
                hx-swap="innerHTML"
                class="mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Sync Label
        </button>
    </div>
    {% elif folder and folder != 'inbox' and folder != 'all' and not q %}
    <div id="folder-sync-status">
        <button hx-post="/emails/sync-folder?folder={{ folder }}&account_id={{ account_id }}"
                hx-target="#folder-sync-status"
                hx-swap="innerHTML"
                class="mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Sync {{ folder|title }} Folder
        </button>
    </div>
    {% endif %}
</div>
{% endif %}
