{#
   Reusable UI Components for Person Pages

   Components:
   - collapsible_section: Expandable/collapsible card sections
   - profile_picture_upload: Profile picture with upload functionality
   - field_display: Display a labeled field value (view mode)
   - field_input: Input field with label (edit mode)
   - multi_entry_display: Display multiple entries (emails, phones, etc.)
#}


{# =============================================================================
   COLLAPSIBLE SECTION

   Creates an expandable/collapsible card section using <details>/<summary>

   Parameters:
   - id: Unique identifier for the section
   - title: Section header text
   - open: Whether section starts expanded (default: true)
   - edit_url: Optional URL for edit button (legacy - navigates to separate page)
   - edit_action: HTMX URL for inline edit (preferred - loads edit form inline)
   - add_action: Optional HTMX action for add button (hx-get URL)
   - add_target: HTMX target for add action
   - person_id: Person ID for inline editing

   Usage:
   {% call collapsible_section('contact-info', 'Contact Information', open=true, edit_action='/api/people/123/sections/contact/edit') %}
     ... section content ...
   {% endcall %}
============================================================================= #}
{% macro collapsible_section(id, title, open=true, edit_url=none, edit_action=none, add_action=none, add_target=none, add_label='Add', person_id=none) %}
<details id="section-{{ id }}" class="bg-white rounded-lg shadow-md overflow-hidden group" {{ 'open' if open else '' }}>
    <summary class="flex items-center justify-between p-4 cursor-pointer select-none hover:bg-blackbook-50 transition-colors">
        <div class="flex items-center space-x-2">
            {# Chevron icon that rotates when open #}
            <svg class="w-5 h-5 text-blackbook-400 transform transition-transform group-open:rotate-90"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <h2 class="text-lg font-semibold text-blackbook-900">{{ title }}</h2>
        </div>
        <div class="flex items-center gap-2" onclick="event.stopPropagation()">
            {% if add_action %}
            <button hx-get="{{ add_action }}"
                    hx-target="{{ add_target or '#modal-container' }}"
                    hx-swap="innerHTML"
                    class="inline-flex items-center px-2 py-1 text-xs bg-blue-50 text-blue-700 font-medium rounded-md hover:bg-blue-100">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                {{ add_label }}
            </button>
            {% endif %}
            {% if edit_action %}
            {# Inline edit via HTMX #}
            <button type="button"
                    hx-get="{{ edit_action }}"
                    hx-target="#section-{{ id }}-content"
                    hx-swap="innerHTML"
                    class="inline-flex items-center px-2 py-1 text-xs bg-blackbook-50 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-100 section-edit-btn"
                    data-section="{{ id }}">
                <svg class="w-3 h-3 mr-1 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
            </button>
            {% elif edit_url %}
            {# Legacy: Navigate to separate edit page #}
            <a href="{{ edit_url }}"
               class="inline-flex items-center px-2 py-1 text-xs bg-blackbook-50 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-100">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
            </a>
            {% endif %}
        </div>
    </summary>
    <div id="section-{{ id }}-content" class="p-4 pt-0 border-t border-blackbook-100">
        {{ caller() }}
    </div>
</details>
{% endmacro %}


{# =============================================================================
   PROFILE PICTURE UPLOAD (View Mode)

   Displays profile picture with option to view larger

   Parameters:
   - person: Person object
   - size: Size class (default: w-16 h-16)
============================================================================= #}
{% macro profile_picture_display(person, size='w-16 h-16') %}
{% if person.profile_picture %}
<img src="{{ person.profile_picture }}"
     alt="{{ person.full_name }}"
     class="{{ size }} rounded-full object-cover border-2 border-blackbook-200 shadow-sm">
{% else %}
<div class="{{ size }} rounded-full bg-blackbook-200 flex items-center justify-center border-2 border-blackbook-300">
    <span class="text-2xl font-semibold text-blackbook-600">
        {{ person.full_name[0]|upper }}{% if person.last_name %}{{ person.last_name[0]|upper }}{% endif %}
    </span>
</div>
{% endif %}
{% endmacro %}


{# =============================================================================
   PROFILE PICTURE UPLOAD (Edit Mode)

   Profile picture with upload/delete functionality via HTMX

   Parameters:
   - person_id: Person UUID
   - current_picture: Current profile picture URL (or None)
   - full_name: Person's full name for initials fallback
============================================================================= #}
{% macro profile_picture_upload(person_id, current_picture, full_name) %}
<div class="flex flex-col items-center space-y-3" id="profile-picture-container">
    {# Current Picture Display #}
    <div class="relative group">
        {% if current_picture %}
        <img src="{{ current_picture }}"
             alt="{{ full_name }}"
             class="w-24 h-24 rounded-full object-cover border-2 border-blackbook-200 shadow-sm"
             id="profile-preview">
        {% else %}
        <div class="w-24 h-24 rounded-full bg-blackbook-200 flex items-center justify-center border-2 border-blackbook-300"
             id="profile-preview-placeholder">
            <span class="text-3xl font-semibold text-blackbook-600">
                {{ full_name[0]|upper }}{% if full_name.split()|length > 1 %}{{ full_name.split()[-1][0]|upper }}{% endif %}
            </span>
        </div>
        {% endif %}

        {# Overlay on hover #}
        <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
             onclick="document.getElementById('profile-file-input').click()">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
        </div>
    </div>

    {# Hidden file input #}
    <input type="file"
           id="profile-file-input"
           accept=".jpg,.jpeg,.png,.gif,.webp"
           class="hidden"
           onchange="uploadProfilePicture(this, '{{ person_id }}')">

    {# Action buttons #}
    <div class="flex items-center space-x-2">
        <button type="button"
                onclick="document.getElementById('profile-file-input').click()"
                class="px-3 py-1.5 text-sm bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100">
            {% if current_picture %}Change{% else %}Upload{% endif %} Photo
        </button>
        {% if current_picture %}
        <button type="button"
                onclick="deleteProfilePicture('{{ person_id }}')"
                class="px-3 py-1.5 text-sm bg-red-50 text-red-700 rounded-md hover:bg-red-100">
            Remove
        </button>
        {% endif %}
    </div>

    <p class="text-xs text-blackbook-400">JPG, PNG, GIF, or WebP (max 5MB)</p>
</div>

<script>
async function uploadProfilePicture(input, personId) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch(`/api/people/${personId}/profile-picture`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            // Refresh the container to show new image
            location.reload();
        } else {
            const error = await response.json();
            alert(error.detail || 'Failed to upload image');
        }
    } catch (e) {
        alert('Failed to upload image');
    }
}

async function deleteProfilePicture(personId) {
    if (!confirm('Remove profile picture?')) return;

    try {
        const response = await fetch(`/api/people/${personId}/profile-picture`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to remove image');
        }
    } catch (e) {
        alert('Failed to remove image');
    }
}
</script>
{% endmacro %}


{# =============================================================================
   FIELD DISPLAY (View Mode)

   Display a labeled field value

   Parameters:
   - label: Field label
   - value: Field value (can be None)
   - icon: Optional SVG icon path
   - link: Optional URL to make value a link
============================================================================= #}
{% macro field_display(label, value, icon=none, link=none) %}
<div class="flex items-start space-x-3">
    {% if icon %}
    <svg class="h-5 w-5 text-blackbook-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        {{ icon|safe }}
    </svg>
    {% endif %}
    <div class="flex-1">
        <span class="text-xs font-medium text-blackbook-500 uppercase tracking-wide">{{ label }}</span>
        {% if value %}
            {% if link %}
            <p class="mt-1"><a href="{{ link }}" target="_blank" class="text-blue-600 hover:underline">{{ value }}</a></p>
            {% else %}
            <p class="text-blackbook-700 mt-1">{{ value }}</p>
            {% endif %}
        {% else %}
        <p class="text-blackbook-400 italic mt-1">Not set</p>
        {% endif %}
    </div>
</div>
{% endmacro %}


{# =============================================================================
   MULTI-ENTRY DISPLAY

   Display a list of entries (emails, phones, websites, etc.)

   Parameters:
   - entries: List of entry objects
   - display_field: Field name to display (e.g., 'email', 'phone')
   - label_field: Field for the label badge (e.g., 'label')
   - link_prefix: Optional prefix for links (e.g., 'mailto:')
   - empty_text: Text when no entries
============================================================================= #}
{% macro multi_entry_display(entries, display_field, label_field='label', link_prefix=none, empty_text='None') %}
{% if entries %}
<div class="space-y-2">
    {% for entry in entries %}
    <div class="flex items-center gap-2 flex-wrap">
        {% set value = entry[display_field] if entry[display_field] is string else entry[display_field] %}
        {% if link_prefix %}
        <a href="{{ link_prefix }}{{ value }}" class="text-blue-600 hover:underline">{{ value }}</a>
        {% else %}
        <span class="text-blackbook-700">{{ value }}</span>
        {% endif %}

        {% if entry[label_field] %}
        {% set label_val = entry[label_field].value if entry[label_field].value is defined else entry[label_field] %}
        <span class="px-2 py-0.5 text-xs rounded-full bg-blackbook-100 text-blackbook-700">
            {{ label_val|title }}
        </span>
        {% endif %}

        {% if entry.is_primary %}
        <span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700">Primary</span>
        {% endif %}

        {% if entry.is_current is defined and not entry.is_current %}
        <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">Past</span>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-blackbook-400 italic">{{ empty_text }}</p>
{% endif %}
{% endmacro %}


{# =============================================================================
   EMPLOYMENT ENTRY DISPLAY

   Display employment/affiliation entries

   Parameters:
   - entries: List of PersonEmployment objects
============================================================================= #}
{% macro employment_display(entries) %}
{% if entries %}
<div class="space-y-4">
    {% for emp in entries %}
    <div class="border-l-4 {{ 'border-green-500' if emp.is_current else 'border-blackbook-300' }} pl-3 py-2">
        <div class="font-medium text-blackbook-900">
            {% if emp.organization %}
            {{ emp.organization.name }}
            {% else %}
            {{ emp.organization_name or 'Unknown' }}
            {% endif %}
        </div>
        {% if emp.title %}
        <div class="text-sm text-blackbook-600">{{ emp.title }}</div>
        {% endif %}
        <div class="flex items-center gap-2 mt-1 flex-wrap">
            {% if emp.affiliation_type %}
            <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">
                {{ emp.affiliation_type.name }}
            </span>
            {% endif %}
            {% if emp.is_current %}
            <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">Current</span>
            {% else %}
            <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">Past</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-blackbook-400 italic">No employment history</p>
{% endif %}
{% endmacro %}


{# =============================================================================
   EDUCATION ENTRY DISPLAY

   Display education entries

   Parameters:
   - entries: List of PersonEducation objects
============================================================================= #}
{% macro education_display(entries) %}
{% if entries %}
<div class="space-y-4">
    {% for edu in entries %}
    <div class="border-l-4 border-purple-400 pl-3 py-2">
        <div class="font-medium text-blackbook-900">{{ edu.school_name }}</div>
        {% if edu.degree_type or edu.field_of_study %}
        <div class="text-sm text-blackbook-600">
            {{ edu.degree_type or '' }}{% if edu.degree_type and edu.field_of_study %} in {% endif %}{{ edu.field_of_study or '' }}
        </div>
        {% endif %}
        {% if edu.graduation_year %}
        <div class="text-xs text-blackbook-500 mt-1">Class of {{ edu.graduation_year }}</div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-blackbook-400 italic">No education history</p>
{% endif %}
{% endmacro %}


{# =============================================================================
   RELATIONSHIP ENTRY DISPLAY

   Display person-to-person relationships

   Parameters:
   - entries: List of PersonRelationship objects
============================================================================= #}
{% macro relationship_display(entries) %}
{% if entries %}
<div class="space-y-3">
    {% for rel in entries %}
    <div class="flex items-center justify-between p-3 bg-blackbook-50 rounded-lg">
        <div class="flex items-center gap-3">
            {# Related person avatar #}
            {% if rel.related_person.profile_picture %}
            <img src="{{ rel.related_person.profile_picture }}"
                 alt="{{ rel.related_person.full_name }}"
                 class="w-10 h-10 rounded-full object-cover">
            {% else %}
            <div class="w-10 h-10 rounded-full bg-blackbook-200 flex items-center justify-center">
                <span class="text-sm font-medium text-blackbook-600">
                    {{ rel.related_person.full_name[0]|upper }}
                </span>
            </div>
            {% endif %}

            <div>
                <a href="/people/{{ rel.related_person.id }}" class="font-medium text-blackbook-900 hover:text-blue-600">
                    {{ rel.related_person.full_name }}
                </a>
                {% if rel.related_person.title %}
                <div class="text-xs text-blackbook-500">{{ rel.related_person.title }}</div>
                {% endif %}
            </div>
        </div>

        <div class="flex items-center gap-2">
            {% if rel.relationship_type %}
            <span class="px-2 py-1 text-xs rounded-full bg-indigo-100 text-indigo-700">
                {{ rel.relationship_type.name }}
            </span>
            {% endif %}
            {% if rel.context_organization %}
            <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                @ {{ rel.context_organization.name }}
            </span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-blackbook-400 italic">No relationships</p>
{% endif %}
{% endmacro %}


{# =============================================================================
   ADDRESS DISPLAY

   Display address entries

   Parameters:
   - entries: List of PersonAddress objects
============================================================================= #}
{% macro address_display(entries) %}
{% if entries %}
<div class="space-y-4">
    {% for addr in entries %}
    <div class="flex items-start gap-3">
        <svg class="h-5 w-5 text-blackbook-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <div class="flex-1">
            <span class="text-xs font-medium text-blackbook-500 uppercase tracking-wide">{{ addr.address_type|title }} Address</span>
            <div class="text-blackbook-700 mt-1">
                {% if addr.street %}{{ addr.street }}<br>{% endif %}
                {% if addr.city or addr.state or addr.zip %}
                {{ addr.city }}{% if addr.city and addr.state %}, {% endif %}{{ addr.state }} {{ addr.zip }}
                <br>
                {% endif %}
                {% if addr.country %}{{ addr.country }}{% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-blackbook-400 italic">No addresses</p>
{% endif %}
{% endmacro %}


{# =============================================================================
   WEBSITE DISPLAY

   Display website entries

   Parameters:
   - entries: List of PersonWebsite objects
============================================================================= #}
{% macro website_display(entries) %}
{% if entries %}
<div class="space-y-2">
    {% for site in entries %}
    <div class="flex items-center gap-2">
        <svg class="h-4 w-4 text-blackbook-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/>
        </svg>
        <a href="{{ site.url }}" target="_blank" class="text-blue-600 hover:underline">
            {{ site.url|replace('https://', '')|replace('http://', '')|truncate(40) }}
        </a>
        {% if site.label %}
        <span class="px-2 py-0.5 text-xs rounded-full bg-blackbook-100 text-blackbook-700">{{ site.label }}</span>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-blackbook-400 italic">No websites</p>
{% endif %}
{% endmacro %}
