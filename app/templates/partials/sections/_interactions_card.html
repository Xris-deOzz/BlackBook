{# Interactions Summary Card with Inline Form #}
<div class="bg-white rounded-lg shadow-md p-6" id="interactions-card">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-blackbook-900">Interactions</h2>
        <div class="flex items-center gap-2">
            <button type="button"
                    onclick="toggleLogInteractionForm()"
                    id="log-interaction-btn"
                    class="inline-flex items-center px-2 py-1 text-xs bg-blackbook-600 text-white font-medium rounded-md hover:bg-blackbook-700">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Log
            </button>
        </div>
    </div>

    <!-- Inline Log Interaction Form (hidden by default) -->
    <div id="log-interaction-form" class="hidden mb-4 p-4 bg-blackbook-50 rounded-lg border border-blackbook-200">
        <form id="interaction-form"
              hx-post="/api/people/{{ person.id }}/interactions/form"
              hx-target="#interactions-card"
              hx-swap="outerHTML"
              class="space-y-3">
            <div>
                <label class="block text-xs font-medium text-blackbook-600 mb-1">Medium *</label>
                <select name="medium" required
                        class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                    <option value="meeting">Meeting</option>
                    <option value="call">Call</option>
                    <option value="video_call">Video Call</option>
                    <option value="email">Email</option>
                    <option value="lunch">Lunch</option>
                    <option value="coffee">Coffee</option>
                    <option value="linkedin">LinkedIn</option>
                    <option value="text">Text</option>
                    <option value="event">Event</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs font-medium text-blackbook-600 mb-1">Date</label>
                    <input type="date" name="interaction_date"
                           class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-blackbook-600 mb-1">Time (optional)</label>
                    <input type="time" name="interaction_time"
                           class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                </div>
            </div>
            <div>
                <label class="block text-xs font-medium text-blackbook-600 mb-1">Notes</label>
                {# Hidden input to store the HTML content #}
                <input type="hidden" name="notes" id="interaction-notes-hidden">
                {# Quill editor container #}
                <div class="quill-editor border border-blackbook-300 rounded-md overflow-hidden bg-white">
                    <div id="interaction-notes-editor" style="min-height: 80px;"></div>
                </div>
            </div>
            <div class="flex flex-col gap-2 pt-2 border-t border-blackbook-200">
                <label class="flex items-center gap-2 text-xs text-blackbook-600 cursor-pointer">
                    <input type="checkbox" name="add_to_calendar" value="true"
                           class="h-4 w-4 text-blue-600 border-blackbook-300 rounded focus:ring-blue-500"
                           onchange="toggleCalendarSelect(this)">
                    <span>Add to Google Calendar</span>
                </label>
                <div id="calendar-account-select" class="hidden ml-6">
                    {% if google_accounts and google_accounts|length > 0 %}
                    <select name="calendar_account_id"
                            class="w-full px-2 py-1 text-xs border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                        {% for account in google_accounts %}
                        <option value="{{ account.id }}">{{ account.email }}</option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <p class="text-xs text-red-500 italic">No Google accounts connected. <a href="/settings/integrations" class="underline">Connect one in Settings</a></p>
                    {% endif %}
                </div>
                <label class="flex items-center gap-2 text-xs text-blackbook-600 cursor-pointer">
                    <input type="checkbox" name="append_to_notes" value="true" checked
                           class="h-4 w-4 text-blue-600 border-blackbook-300 rounded focus:ring-blue-500">
                    <span>Append to person's Notes</span>
                </label>
            </div>
            <div class="flex justify-end gap-2 pt-1">
                <button type="button" onclick="toggleLogInteractionForm()"
                        class="px-3 py-1.5 text-sm text-blackbook-600 hover:text-blackbook-800">
                    Cancel
                </button>
                <button type="submit"
                        class="px-3 py-1.5 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700">
                    Save
                </button>
            </div>
        </form>
    </div>

    <!-- Summary Stats -->
    <div class="flex items-center justify-between py-3 border-b border-blackbook-100">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <span class="text-blackbook-700 font-medium">{{ interactions|length }} interaction{% if interactions|length != 1 %}s{% endif %}</span>
        </div>
        {% if interactions %}
        <span class="text-xs text-blackbook-500">
            Last: {{ interactions[0].interaction_date.strftime('%b %d, %Y') if interactions[0].interaction_date else 'N/A' }}
        </span>
        {% endif %}
    </div>

    <!-- Recent Interaction Preview -->
    {% if interactions %}
    <div class="mt-3">
        <div class="text-xs font-medium text-blackbook-500 mb-2 uppercase tracking-wide">Most Recent</div>
        {% set latest = interactions[0] %}
        <div class="p-3 bg-blackbook-50 rounded-lg">
            <div class="flex items-center gap-2 mb-1">
                {% set medium_colors = {
                    'email': 'bg-blue-100 text-blue-800',
                    'meeting': 'bg-green-100 text-green-800',
                    'call': 'bg-yellow-100 text-yellow-800',
                    'linkedin': 'bg-sky-100 text-sky-800',
                    'lunch': 'bg-orange-100 text-orange-800',
                    'coffee': 'bg-amber-100 text-amber-800',
                    'event': 'bg-purple-100 text-purple-800',
                    'video_call': 'bg-indigo-100 text-indigo-800',
                    'text': 'bg-pink-100 text-pink-800',
                    'other': 'bg-gray-100 text-gray-800'
                } %}
                <span class="px-2 py-0.5 text-xs font-medium rounded-full {{ medium_colors.get(latest.medium.value, 'bg-gray-100 text-gray-800') }}">
                    {{ latest.medium.value|replace('_', ' ')|title }}
                </span>
                {% if latest.interaction_date %}
                <span class="text-xs text-blackbook-500">
                    {{ latest.interaction_date.strftime('%b %d, %Y') }}
                </span>
                {% endif %}
            </div>
            {% if latest.notes %}
            <p class="text-sm text-blackbook-600 line-clamp-2">{{ latest.notes|striptags|truncate(80) }}</p>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="mt-3 text-center py-4">
        <p class="text-blackbook-400 italic">No interactions recorded</p>
    </div>
    {% endif %}

    <!-- View All Button -->
    <button hx-get="/people/{{ person.id }}/interactions/modal"
            hx-target="#interactions-modal-container"
            hx-swap="innerHTML"
            class="w-full mt-4 px-4 py-2 text-sm font-medium text-blackbook-700 bg-blackbook-100 hover:bg-blackbook-200 rounded-lg transition-colors flex items-center justify-center">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
        </svg>
        View All Interactions
    </button>
</div>

<script>
function toggleLogInteractionForm() {
    const form = document.getElementById('log-interaction-form');
    form.classList.toggle('hidden');

    // Initialize Quill editor when form is shown
    if (!form.classList.contains('hidden')) {
        initInteractionNotesEditor();
    }
}

function toggleCalendarSelect(checkbox) {
    const selectDiv = document.getElementById('calendar-account-select');
    if (checkbox.checked) {
        selectDiv.classList.remove('hidden');
    } else {
        selectDiv.classList.add('hidden');
    }
}

function initInteractionNotesEditor() {
    const editorEl = document.getElementById('interaction-notes-editor');
    if (!editorEl || editorEl.querySelector('.ql-editor')) return; // Already initialized

    const quill = new Quill('#interaction-notes-editor', {
        theme: 'snow',
        placeholder: 'What did you discuss?',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                ['clean']
            ]
        }
    });

    const form = document.getElementById('interaction-form');
    const hiddenInput = document.getElementById('interaction-notes-hidden');

    if (form && hiddenInput) {
        // Prevent default form submission - let HTMX handle it
        form.addEventListener('submit', function(evt) {
            // Update hidden input with Quill content before HTMX processes
            let content = quill.root.innerHTML;
            if (content === '<p><br></p>' || content === '<p></p>') content = '';
            hiddenInput.value = content;
        });

        // Update hidden input before HTMX request
        form.addEventListener('htmx:configRequest', function(evt) {
            let content = quill.root.innerHTML;
            if (content === '<p><br></p>' || content === '<p></p>') content = '';
            hiddenInput.value = content;
        });

        // Also update on text change
        quill.on('text-change', function() {
            let content = quill.root.innerHTML;
            if (content === '<p><br></p>' || content === '<p></p>') content = '';
            hiddenInput.value = content;
        });
    }
}
</script>
