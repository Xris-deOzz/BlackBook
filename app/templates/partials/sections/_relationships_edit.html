{# Relationships Section - Edit Mode #}
<div class="space-y-4">
    {# My Relationship Section #}
    <details open class="group">
        <summary class="cursor-pointer flex items-center gap-2 text-xs font-semibold text-blackbook-500 uppercase tracking-wide hover:text-blackbook-700">
            <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            My Relationship
        </summary>
        <div class="mt-2 p-4 border border-blackbook-200 rounded-lg bg-blackbook-50">
            <p class="text-xs text-blackbook-500 mb-3">How do you know {{ person.first_name or person.full_name }}?</p>
            <form hx-post="/api/people/{{ person.id }}/my-relationship"
                  hx-target="#section-relationships-content"
                  hx-swap="innerHTML"
                  class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-blackbook-600 mb-1">Relationship Type</label>
                    <select name="my_relationship_type_id"
                            class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 bg-white">
                        <option value="">Select how you know them...</option>
                        {% for rtype in relationship_types %}
                        <option value="{{ rtype.id }}"
                                {% if person.my_relationship_type_id and person.my_relationship_type_id == rtype.id %}selected{% endif %}>
                            {{ rtype.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-blackbook-600 mb-1">Notes</label>
                    <textarea name="my_relationship_notes" rows="2"
                              placeholder="e.g., Met at YC Demo Day 2019, introduced by John Smith"
                              class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">{{ person.my_relationship_notes or '' }}</textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit"
                            class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </details>

    {# Their Connections Section #}
    <details open class="group">
        <summary class="cursor-pointer flex items-center gap-2 text-xs font-semibold text-blackbook-500 uppercase tracking-wide hover:text-blackbook-700">
            <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            Their Connections
            {% if person.relationships_from %}
            <span class="text-blackbook-400 font-normal">({{ person.relationships_from|length }})</span>
            {% endif %}
        </summary>

        <div class="mt-2 space-y-3">
            {# Existing Relationships #}
            {% if person.relationships_from %}
            <div class="space-y-2" id="relationships-list">
                {# Sort by display_order (family first) #}
                {% set sorted_relationships = person.relationships_from|sort(attribute='relationship_type.display_order,related_person.full_name') %}
                {% for rel in sorted_relationships %}
                <div class="flex items-center justify-between p-3 bg-blackbook-50 rounded-lg border border-blackbook-200">
                    <div class="flex items-center gap-3">
                        {# Related person avatar #}
                        {% if rel.related_person.profile_picture %}
                        <img src="{{ rel.related_person.profile_picture }}"
                             alt="{{ rel.related_person.full_name }}"
                             class="w-10 h-10 rounded-full object-cover">
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-blackbook-200 flex items-center justify-center">
                            <span class="text-sm font-medium text-blackbook-600">
                                {{ rel.related_person.full_name[0]|upper }}
                            </span>
                        </div>
                        {% endif %}

                        <div>
                            <span class="font-medium text-blackbook-900">{{ rel.related_person.full_name }}</span>
                            {% if rel.relationship_type %}
                            {# Color-code by category #}
                            {% set badge_class = {
                                'family': 'bg-pink-100 text-pink-700',
                                'education': 'bg-yellow-100 text-yellow-700',
                                'professional': 'bg-green-100 text-green-700',
                                'introduction': 'bg-purple-100 text-purple-700',
                                'personal': 'bg-blue-100 text-blue-700'
                            }.get(rel.relationship_type.category, 'bg-gray-100 text-gray-600') %}
                            <span class="ml-2 px-2 py-0.5 text-xs rounded-full {{ badge_class }}">
                                {{ rel.relationship_type.name }}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <button type="button"
                            hx-delete="/api/people/{{ person.id }}/relationships/{{ rel.id }}/inline"
                            hx-target="#section-relationships-content"
                            hx-swap="innerHTML"
                            hx-confirm="Remove this relationship?"
                            class="p-1 text-blackbook-400 hover:text-red-600"
                            title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-blackbook-400 italic text-sm p-3 bg-blackbook-50 rounded-lg">No connections yet</p>
            {% endif %}

            {# Add New Relationship Form #}
            <div id="add-relationship-form" class="border border-dashed border-blackbook-300 rounded-lg p-4">
                <button type="button"
                        onclick="toggleAddRelationshipForm()"
                        id="add-relationship-btn"
                        class="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Connection
                </button>

                <form id="new-relationship-form"
                      hx-post="/api/people/{{ person.id }}/relationships/form"
                      hx-target="#section-relationships-content"
                      hx-swap="innerHTML"
                      class="hidden mt-4 space-y-3">
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-blackbook-600 mb-1">Related Person *</label>
                            <select id="relationship-person-select" name="related_person_id" required
                                    placeholder="Type to search...">
                                <option value="">Select person...</option>
                                {% for p in all_persons %}
                                {% if p.id != person.id %}
                                <option value="{{ p.id }}">{{ p.full_name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-blackbook-600 mb-1">Relationship Type</label>
                            <select name="relationship_type_id"
                                    class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                                <option value="">Select type...</option>
                                {% for rtype in relationship_types %}
                                <option value="{{ rtype.id }}">{{ rtype.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-blackbook-600 mb-1">Context / Notes</label>
                            <textarea name="context_text" rows="2"
                                      placeholder="e.g., Introduced to Jane in June 2025"
                                      class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 pt-2">
                        <button type="button" onclick="toggleAddRelationshipForm()"
                                class="px-3 py-1.5 text-sm text-blackbook-600 hover:text-blackbook-800">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-3 py-1.5 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700">
                            Add
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </details>

    {# Done button to return to view mode #}
    <div class="flex justify-end pt-2">
        <button type="button"
                hx-get="/api/people/{{ person.id }}/sections/relationships/view"
                hx-target="#section-relationships-content"
                hx-swap="innerHTML"
                class="px-4 py-2 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700">
            Done
        </button>
    </div>
</div>

<script>
var relationshipPersonSelect = null;

function toggleAddRelationshipForm() {
    const form = document.getElementById('new-relationship-form');
    const btn = document.getElementById('add-relationship-btn');
    form.classList.toggle('hidden');
    btn.classList.toggle('hidden');

    // Initialize Tom Select when form is shown
    if (!form.classList.contains('hidden') && !relationshipPersonSelect) {
        const selectEl = document.getElementById('relationship-person-select');
        if (selectEl && typeof TomSelect !== 'undefined') {
            relationshipPersonSelect = new TomSelect(selectEl, {
                placeholder: 'Type to search...',
                allowEmptyOption: true,
                sortField: { field: 'text', direction: 'asc' },
                create: true,
                createOnBlur: false,
                createFilter: function(input) {
                    // Only allow creation if at least 2 characters
                    return input.length >= 2;
                },
                render: {
                    option_create: function(data, escape) {
                        return '<div class="create px-3 py-2 text-blue-600 hover:bg-blue-50 border-t border-blackbook-200 cursor-pointer">' +
                            '<svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>' +
                            '</svg>' +
                            'Create new person: <strong>' + escape(data.input) + '</strong>' +
                            '</div>';
                    },
                    no_results: function(data, escape) {
                        return '<div class="no-results px-3 py-2 text-blackbook-500">No matches found. Type a name to create a new person.</div>';
                    }
                },
                onOptionAdd: async function(value, data) {
                    // This is called when user selects "Create new person"
                    // We need to call the API to actually create the person
                    await createNewPersonForRelationship(value, this);
                }
            });
        }
    }
}

async function createNewPersonForRelationship(name, tomSelectInstance) {
    try {
        const formData = new FormData();
        formData.append('name', name);

        const response = await fetch('/api/persons/quick-create', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Failed to create person');
        }

        const result = await response.json();

        // Update Tom Select with the real ID
        // Remove the temporary option (the name string) and add the real one
        tomSelectInstance.removeOption(name);
        tomSelectInstance.addOption({
            value: result.id,
            text: result.name
        });
        tomSelectInstance.setValue(result.id);

        // Show feedback
        if (result.existing) {
            showToast('Found existing person: ' + result.name, 'info');
        } else {
            showToast('Created new person: ' + result.name, 'success');
        }
    } catch (error) {
        console.error('Error creating person:', error);
        showToast('Failed to create person', 'error');
        // Clear the selection
        tomSelectInstance.clear();
    }
}

function showToast(message, type) {
    // Simple toast notification
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
    toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Re-initialize Tom Select after HTMX swaps (for when form is reloaded)
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'section-relationships-content') {
        relationshipPersonSelect = null;
    }
});
</script>
