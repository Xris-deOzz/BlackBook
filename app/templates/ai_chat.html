{% extends "base.html" %}

{% block title %}AI Conversations - Perun's BlackBook{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-blackbook-900">AI Conversations</h1>
            <p class="text-sm text-blackbook-500 mt-1">View and manage your AI research conversations</p>
        </div>
        <div class="flex gap-2">
            <button onclick="openResearchModal('person')" class="inline-flex items-center px-4 py-2 border border-blackbook-300 rounded-lg text-sm font-medium text-blackbook-700 hover:bg-blackbook-50 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Research Person
            </button>
            <button onclick="openResearchModal('company')" class="inline-flex items-center px-4 py-2 border border-blackbook-300 rounded-lg text-sm font-medium text-blackbook-700 hover:bg-blackbook-50 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                Research Company
            </button>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-md p-4">
            <p class="text-sm text-blackbook-500">Total Conversations</p>
            <p class="text-2xl font-bold text-blackbook-900">{{ stats.total_conversations }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <p class="text-sm text-blackbook-500">Total Messages</p>
            <p class="text-2xl font-bold text-blackbook-900">{{ stats.total_messages }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <p class="text-sm text-blackbook-500">Tokens Used</p>
            <p class="text-2xl font-bold text-blackbook-900">
                {% if stats.total_tokens >= 1000000 %}
                    {{ "%.1f"|format(stats.total_tokens / 1000000) }}M
                {% elif stats.total_tokens >= 1000 %}
                    {{ "%.1f"|format(stats.total_tokens / 1000) }}K
                {% else %}
                    {{ stats.total_tokens }}
                {% endif %}
            </p>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <p class="text-sm text-blackbook-500">Pending Suggestions</p>
            <p class="text-2xl font-bold text-orange-600">{{ stats.pending_suggestions }}</p>
        </div>
    </div>

    <!-- Conversations List -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="px-6 py-4 border-b border-blackbook-200">
            <h2 class="text-lg font-semibold text-blackbook-900">All Conversations</h2>
        </div>
        <div class="divide-y divide-blackbook-200">
            {% if conversations %}
                {% for item in conversations %}
                <a href="{{ item.entity_url }}?open_ai=true" class="block px-6 py-4 hover:bg-blackbook-50 transition-colors">
                    <div class="flex items-start gap-4">
                        <!-- AI Icon -->
                        <div class="flex-shrink-0 mt-1">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611l-2.025.338a7.022 7.022 0 01-2.722-.014l-.014-.003a7.022 7.022 0 00-2.722.014l-2.025.338c-1.717.293-2.299-2.379-1.067-3.61L5 14.5" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-4">
                                <div class="min-w-0">
                                    <p class="text-sm font-medium text-blackbook-900 truncate">
                                        {{ item.conversation.title }}
                                    </p>
                                    <div class="flex items-center gap-3 mt-1">
                                        {% if item.entity_name %}
                                        <span class="inline-flex items-center text-xs text-blackbook-500">
                                            {% if item.entity_type == 'person' %}
                                            <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                            {% else %}
                                            <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                            </svg>
                                            {% endif %}
                                            {{ item.entity_name }}
                                        </span>
                                        {% endif %}
                                        <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-blackbook-100 text-blackbook-600">
                                            {{ item.conversation.provider_name or 'Unknown' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-shrink-0 text-right">
                                    <p class="text-xs text-blackbook-400">
                                        {{ item.conversation.updated_at.strftime('%b %d, %Y') }}
                                    </p>
                                    <p class="text-xs text-blackbook-400 mt-1">
                                        {{ item.conversation.updated_at.strftime('%I:%M %p') }}
                                    </p>
                                </div>
                            </div>
                            <!-- Message preview -->
                            {% if item.conversation.messages %}
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-xs text-blackbook-400 bg-blackbook-100 rounded-full px-2 py-0.5">
                                    {{ item.conversation.messages | length }} messages
                                </span>
                                {% if item.tokens_used %}
                                <span class="text-xs text-blackbook-400">
                                    {{ item.tokens_used }} tokens
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <!-- Arrow -->
                        <div class="flex-shrink-0 self-center">
                            <svg class="w-5 h-5 text-blackbook-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
            <div class="px-6 py-12 text-center">
                <svg class="mx-auto h-16 w-16 text-blackbook-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <h3 class="mt-4 text-lg font-medium text-blackbook-900">No AI conversations yet</h3>
                <p class="mt-2 text-sm text-blackbook-500">Start researching a person or company to begin an AI conversation.</p>
                <div class="mt-6 flex justify-center gap-3">
                    <button onclick="openResearchModal('person')" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Research a Person
                    </button>
                    <button onclick="openResearchModal('company')" class="inline-flex items-center px-4 py-2 border border-blackbook-300 rounded-lg text-sm font-medium text-blackbook-700 hover:bg-blackbook-50 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Research a Company
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Research Modal -->
<div id="research-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[80vh] flex flex-col">
        <div class="px-6 py-4 border-b border-blackbook-200 flex-shrink-0">
            <h3 id="research-modal-title" class="text-lg font-semibold text-blackbook-900">Research</h3>
        </div>
        <div class="p-6 flex-1 overflow-hidden flex flex-col">
            <!-- Search Input -->
            <div class="mb-4">
                <input type="text"
                       id="research-search-input"
                       placeholder="Type a name to search..."
                       class="w-full border border-blackbook-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       autocomplete="off"
                       oninput="onResearchSearch(this.value)">
                <p id="research-modal-desc" class="text-xs text-blackbook-500 mt-2">
                    Search your contacts or enter a new name to research
                </p>
            </div>

            <!-- Search Results -->
            <div id="research-results" class="flex-1 overflow-y-auto min-h-0 border border-blackbook-200 rounded-lg">
                <div class="p-4 text-center text-sm text-blackbook-500">
                    Start typing to search...
                </div>
            </div>

            <!-- Or Research New -->
            <div id="research-new-section" class="mt-4 pt-4 border-t border-blackbook-200 hidden">
                <p class="text-sm text-blackbook-600 mb-2">Or research someone new:</p>
                <div class="flex gap-2">
                    <input type="text"
                           id="research-new-name"
                           placeholder="Enter name..."
                           class="flex-1 border border-blackbook-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button onclick="researchNewEntity()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition-colors">
                        Research
                    </button>
                </div>
            </div>
        </div>
        <div class="px-6 py-4 bg-blackbook-50 rounded-b-lg flex justify-end gap-2 flex-shrink-0">
            <button onclick="closeResearchModal()" class="px-4 py-2 text-sm text-blackbook-600 hover:text-blackbook-800">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    let currentResearchType = null;
    let searchTimeout = null;

    function openResearchModal(type) {
        currentResearchType = type;
        const modal = document.getElementById('research-modal');
        const title = document.getElementById('research-modal-title');
        const desc = document.getElementById('research-modal-desc');
        const searchInput = document.getElementById('research-search-input');
        const results = document.getElementById('research-results');
        const newSection = document.getElementById('research-new-section');
        const newNameInput = document.getElementById('research-new-name');

        if (type === 'person') {
            title.textContent = 'Research a Person';
            searchInput.placeholder = 'Type a name to search your contacts...';
            desc.textContent = 'Search your contacts or enter a new name to research';
            newNameInput.placeholder = 'Enter person name...';
        } else {
            title.textContent = 'Research a Company';
            searchInput.placeholder = 'Type a company name to search...';
            desc.textContent = 'Search your organizations or enter a new name to research';
            newNameInput.placeholder = 'Enter company name...';
        }

        // Reset state
        searchInput.value = '';
        newNameInput.value = '';
        results.innerHTML = '<div class="p-4 text-center text-sm text-blackbook-500">Start typing to search...</div>';
        newSection.classList.add('hidden');

        modal.classList.remove('hidden');

        // Focus the search input
        setTimeout(() => searchInput.focus(), 100);
    }

    function closeResearchModal() {
        document.getElementById('research-modal').classList.add('hidden');
        currentResearchType = null;
        if (searchTimeout) clearTimeout(searchTimeout);
    }

    function onResearchSearch(query) {
        const results = document.getElementById('research-results');
        const newSection = document.getElementById('research-new-section');

        // Clear previous timeout
        if (searchTimeout) clearTimeout(searchTimeout);

        // Show "Or research new" section when user starts typing
        if (query.trim().length > 0) {
            newSection.classList.remove('hidden');
            document.getElementById('research-new-name').value = query;
        } else {
            newSection.classList.add('hidden');
            results.innerHTML = '<div class="p-4 text-center text-sm text-blackbook-500">Start typing to search...</div>';
            return;
        }

        // Debounce search
        searchTimeout = setTimeout(() => {
            performResearchSearch(query);
        }, 300);
    }

    async function performResearchSearch(query) {
        const results = document.getElementById('research-results');

        if (query.trim().length < 2) {
            results.innerHTML = '<div class="p-4 text-center text-sm text-blackbook-500">Type at least 2 characters...</div>';
            return;
        }

        results.innerHTML = '<div class="p-4 text-center text-sm text-blackbook-500">Searching...</div>';

        const endpoint = currentResearchType === 'person'
            ? `/ai-chat/search/people?q=${encodeURIComponent(query)}&limit=20`
            : `/ai-chat/search/organizations?q=${encodeURIComponent(query)}&limit=20`;

        try {
            const response = await fetch(endpoint);
            const data = await response.json();

            if (data.length === 0) {
                results.innerHTML = `
                    <div class="p-4 text-center text-sm text-blackbook-500">
                        No ${currentResearchType === 'person' ? 'people' : 'organizations'} found matching "${query}"
                        <br><span class="text-xs">Use the field below to research this name</span>
                    </div>
                `;
                return;
            }

            if (currentResearchType === 'person') {
                results.innerHTML = data.map(p => `
                    <button onclick="selectResearchEntity('${p.id}')"
                            class="w-full px-4 py-3 text-left hover:bg-blackbook-50 border-b border-blackbook-100 last:border-b-0 transition-colors">
                        <div class="font-medium text-sm text-blackbook-900">${escapeHtml(p.full_name)}</div>
                        ${p.title ? `<div class="text-xs text-blackbook-500">${escapeHtml(p.title)}</div>` : ''}
                    </button>
                `).join('');
            } else {
                results.innerHTML = data.map(o => `
                    <button onclick="selectResearchEntity('${o.id}')"
                            class="w-full px-4 py-3 text-left hover:bg-blackbook-50 border-b border-blackbook-100 last:border-b-0 transition-colors">
                        <div class="font-medium text-sm text-blackbook-900">${escapeHtml(o.name)}</div>
                        ${o.category ? `<div class="text-xs text-blackbook-500">${escapeHtml(o.category)}</div>` : ''}
                    </button>
                `).join('');
            }
        } catch (error) {
            results.innerHTML = '<div class="p-4 text-center text-sm text-red-500">Error searching. Please try again.</div>';
        }
    }

    function selectResearchEntity(entityId) {
        // Navigate to entity detail page (which has the AI sidebar)
        if (currentResearchType === 'person') {
            window.location.href = `/people/${entityId}?open_ai=true`;
        } else {
            window.location.href = `/organizations/${entityId}?open_ai=true`;
        }
    }

    function researchNewEntity() {
        const name = document.getElementById('research-new-name').value.trim();
        if (!name) return;

        // Navigate to AI research page with the name as a parameter
        // This will create a new research session for an unknown entity
        const encodedName = encodeURIComponent(name);
        window.location.href = `/ai-chat/research-new?type=${currentResearchType}&name=${encodedName}`;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeResearchModal();
        }
    });

    // Close modal on backdrop click
    document.getElementById('research-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeResearchModal();
        }
    });
</script>
{% endblock %}
