{% extends "base.html" %}

{% block breadcrumb %}
<nav class="bg-white border-b border-blackbook-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <ol class="flex items-center space-x-2 text-sm">
            <li>
                <a href="/" class="text-blackbook-500 hover:text-blackbook-700">Home</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li>
                <a href="/settings" class="text-blackbook-500 hover:text-blackbook-700">Settings</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li class="text-blackbook-900 font-medium">Duplicate Management</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" id="main-content">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-blackbook-900">Duplicate Management</h1>
                <p class="text-blackbook-500 mt-1">Review and merge duplicate person records</p>
            </div>
            <a href="/settings" class="text-blackbook-600 hover:text-blackbook-800 text-sm inline-flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Back to Settings
            </a>
        </div>
    </div>

    {% if merge_success %}
    <!-- Success Message -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex">
            <svg class="h-5 w-5 text-green-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-sm text-green-800">
                <p class="font-medium">Merge completed successfully!</p>
                <p class="mt-1">
                    Merged {{ merge_result.merged_person_ids|length }} record(s).
                    Transferred: {{ merge_result.emails_transferred }} emails,
                    {{ merge_result.phones_transferred }} phones,
                    {{ merge_result.orgs_transferred }} organizations,
                    {{ merge_result.tags_transferred }} tags,
                    {{ merge_result.interactions_transferred }} interactions.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if merge_all_success %}
    <!-- Merge All Success Message -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex">
            <svg class="h-5 w-5 text-green-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-sm text-green-800">
                <p class="font-medium">All duplicates merged successfully!</p>
                <p class="mt-1">
                    Merged {{ merge_all_result.groups_merged }} duplicate group(s) ({{ merge_all_result.total_persons_merged }} persons).
                    Transferred: {{ merge_all_result.emails_transferred }} emails,
                    {{ merge_all_result.phones_transferred }} phones,
                    {{ merge_all_result.orgs_transferred }} organizations,
                    {{ merge_all_result.tags_transferred }} tags,
                    {{ merge_all_result.interactions_transferred }} interactions.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-lg border border-blackbook-200 mb-6">
        <div class="border-b border-blackbook-200">
            <nav class="flex -mb-px">
                <a href="/settings/duplicates" 
                   class="px-6 py-3 border-b-2 border-blackbook-600 text-blackbook-900 font-medium text-sm">
                    Exact Duplicates
                </a>
                <a href="/settings/duplicates/fuzzy" 
                   class="px-6 py-3 border-b-2 border-transparent text-blackbook-500 hover:text-blackbook-700 hover:border-blackbook-300 font-medium text-sm">
                    Similar Names
                    {% if fuzzy_groups is defined and fuzzy_groups|length > 0 %}
                    <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded-full text-xs">
                        {{ fuzzy_groups|length }}
                    </span>
                    {% endif %}
                </a>
                <a href="/settings/duplicates/exclusions" 
                   class="px-6 py-3 border-b-2 border-transparent text-blackbook-500 hover:text-blackbook-700 hover:border-blackbook-300 font-medium text-sm">
                    Excluded Pairs
                    {% if exclusion_count is defined and exclusion_count > 0 %}
                    <span class="ml-2 px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs">
                        {{ exclusion_count }}
                    </span>
                    {% endif %}
                </a>
            </nav>
        </div>
    </div>

    <!-- Stats Card -->
    <div class="bg-white rounded-lg border border-blackbook-200 p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-blackbook-900">
                    {{ duplicate_groups|length }} Duplicate Groups Found
                </h2>
                <p class="text-sm text-blackbook-500">
                    Showing persons with identical full names (first + last name)
                </p>
            </div>
            <div class="flex items-center space-x-3">
                {% if duplicate_groups %}
                <form action="/settings/duplicates/merge-all" method="POST" onsubmit="return confirm('Are you sure you want to merge ALL duplicate groups? This will keep the oldest record in each group and merge all others into it. This action cannot be undone.');">
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Merge All Duplicates
                    </button>
                </form>
                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                    Needs Review
                </span>
                {% else %}
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    All Clean
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    {% if duplicate_groups %}
    <!-- Duplicates List -->
    <div class="space-y-4">
        {% for group in duplicate_groups %}
        <div class="bg-white rounded-lg border border-blackbook-200 overflow-hidden">
            <!-- Group Header -->
            <div class="px-6 py-4 bg-blackbook-50 border-b border-blackbook-200 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm font-medium">
                        {{ group.count }} duplicates
                    </span>
                    <h3 class="text-lg font-semibold text-blackbook-900">{{ group.full_name }}</h3>
                </div>
                <a href="/settings/duplicates/merge?name={{ group.full_name | urlencode }}"
                   class="px-4 py-2 bg-blackbook-600 text-white text-sm font-medium rounded-md hover:bg-blackbook-700">
                    Review & Merge
                </a>
            </div>

            <!-- Person Cards -->
            <div class="divide-y divide-blackbook-100">
                {% for person in group.persons %}
                <div class="px-6 py-4 flex items-center justify-between hover:bg-blackbook-50">
                    <div class="flex items-center space-x-4">
                        <!-- Avatar -->
                        {% if person.profile_picture %}
                        <img src="{{ person.profile_picture }}" alt="{{ person.full_name }}"
                             class="w-10 h-10 rounded-full object-cover">
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-blackbook-200 flex items-center justify-center">
                            <span class="text-blackbook-600 font-medium">
                                {{ person.full_name[0] if person.full_name else '?' }}
                            </span>
                        </div>
                        {% endif %}

                        <div>
                            <a href="/people/{{ person.id }}" class="font-medium text-blackbook-900 hover:text-blackbook-700">
                                {{ person.full_name }}
                            </a>
                            <div class="text-sm text-blackbook-500 space-x-3">
                                {% if person.title %}
                                <span>{{ person.title }}</span>
                                {% endif %}
                                {% if person.email %}
                                <span>{{ person.email }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4 text-sm text-blackbook-500">
                        <!-- Data indicators -->
                        {% if person.linkedin %}
                        <span class="text-blue-600" title="Has LinkedIn">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                            </svg>
                        </span>
                        {% endif %}
                        {% if person.emails|length > 0 %}
                        <span title="{{ person.emails|length }} email(s)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </span>
                        {% endif %}
                        {% if person.tags|length > 0 %}
                        <span title="{{ person.tags|length }} tag(s)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                            </svg>
                        </span>
                        {% endif %}

                        <!-- Created date -->
                        <span class="text-blackbook-400">
                            Created {{ person.created_at.strftime('%b %d, %Y') }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="bg-white rounded-lg border border-blackbook-200 p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h3 class="mt-4 text-lg font-medium text-blackbook-900">No Duplicates Found</h3>
        <p class="mt-2 text-blackbook-500">Your contact database is clean with no duplicate full names.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
