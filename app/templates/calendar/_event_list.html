{% if error %}
<div class="bg-red-50 border border-red-200 rounded-lg p-4">
    <p class="text-sm text-red-600">{{ error }}</p>
</div>
{% elif events %}
<div class="space-y-2">
    {% set current_date = namespace(value=None) %}
    {% for item in events %}
    {# Day separator - show date header when day changes #}
    {% set event_date = item.event.start_time_local.date() if item.event.start_time_local else item.event.start_time.date() %}
    {% if current_date.value != event_date %}
        {% set current_date.value = event_date %}
        <div class="{% if not loop.first %}mt-4 pt-4 border-t border-blackbook-200{% endif %}">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-xs font-semibold text-blackbook-700 uppercase tracking-wide">
                    {% if event_date == today %}
                        Today
                    {% elif event_date == tomorrow %}
                        Tomorrow
                    {% else %}
                        {{ event_date.strftime('%A, %B %d') }}
                    {% endif %}
                </span>
            </div>
        </div>
    {% endif %}
    <div class="border-l-2 border-green-200 pl-4 py-3 hover:bg-green-50 -ml-4 -mr-2 px-4 rounded-r transition-colors group">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 flex-wrap">
                <span class="text-sm font-medium text-blackbook-900">
                    {{ item.event.summary or '(No title)' }}
                </span>
                {% if item.event.is_video_call %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                    Video Call
                </span>
                {% endif %}
            </div>
            <span class="text-xs text-blackbook-400 whitespace-nowrap ml-2">
                {{ item.event.duration_minutes }} min
            </span>
        </div>

        <div class="flex items-center gap-2 mt-1 text-xs text-blackbook-500">
            {# Use local time if available, otherwise use UTC time #}
            {% set start_time = item.event.start_time_local if item.event.start_time_local else item.event.start_time %}
            {% set end_time = item.event.end_time_local if item.event.end_time_local else item.event.end_time %}
            <span>{{ start_time.strftime('%I:%M %p') }}</span>
            <span>-</span>
            <span>{{ end_time.strftime('%I:%M %p') }}</span>
        </div>

        {% if item.attendees %}
        <div class="mt-2">
            <div class="flex items-center gap-1 flex-wrap">
                {% if item.known_count > 0 %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                    {{ item.known_count }} known
                </span>
                {% endif %}
                {% if item.unknown_count > 0 %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                    {{ item.unknown_count }} unknown
                </span>
                {% endif %}
            </div>
            <div class="mt-1 flex flex-wrap gap-1">
                {% for attendee in item.attendees[:5] %}
                {% if attendee.person_id %}
                <a href="/people/{{ attendee.person_id }}"
                   class="text-xs text-blue-600 hover:underline">
                    {{ attendee.person_name or attendee.email }}
                </a>
                {% else %}
                <span class="text-xs text-blackbook-500">{{ attendee.name or attendee.email }}</span>
                {% endif %}
                {% if not loop.last %}<span class="text-xs text-blackbook-300">,</span>{% endif %}
                {% endfor %}
                {% if item.attendees|length > 5 %}
                <span class="text-xs text-blackbook-400">+{{ item.attendees|length - 5 }} more</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if item.event.location %}
        <p class="text-xs text-blackbook-500 mt-1 truncate">
            {{ item.event.location }}
        </p>
        {% endif %}

        <div class="flex items-center gap-3 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button
                hx-post="/calendar/event/{{ item.event.id }}/log"
                hx-target="#calendar-log-result"
                hx-swap="innerHTML"
                class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                Log as Interactions
            </button>
            <a href="{{ item.event.google_calendar_url }}" target="_blank"
               class="text-xs text-blackbook-500 hover:text-blackbook-700">
                View in Calendar
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<div id="calendar-log-result" class="mt-2"></div>

{% else %}
<div class="text-center py-8">
    <svg class="mx-auto h-12 w-12 text-blackbook-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
    <p class="mt-2 text-sm text-blackbook-500">{{ empty_message or 'No events found' }}</p>
</div>
{% endif %}
