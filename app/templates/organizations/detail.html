{% extends "base.html" %}
{% from "partials/_components.html" import collapsible_section %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="/organizations" class="text-blackbook-600 hover:text-blackbook-800 text-sm mb-4 inline-flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to Organizations
        </a>

        <div class="flex items-start justify-between">
            <div class="flex items-center gap-4">
                <!-- Organization Logo -->
                {% if organization.logo %}
                <img src="{{ organization.logo }}" alt="{{ organization.name }}"
                     class="w-16 h-16 rounded-lg object-contain border border-blackbook-200 bg-white p-1 shadow-sm cursor-pointer hover:opacity-80 transition-opacity"
                     onclick="openLogoModal()"
                     title="Click to enlarge">
                {% else %}
                <div class="w-16 h-16 rounded-lg bg-blackbook-100 flex items-center justify-center border border-blackbook-200">
                    <svg class="w-8 h-8 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                {% endif %}
                <div>
                    <h1 class="text-3xl font-bold text-blackbook-900">{{ organization.name }}</h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- AI Research Button -->
                <button onclick="openAiSidebar()"
                        class="inline-flex items-center px-3 py-1.5 bg-blackbook-100 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-200 transition-colors">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    AI Research
                </button>

                <!-- Edit All Sections Button -->
                <button id="edit-all-btn"
                        onclick="enterEditAllMode()"
                        class="inline-flex items-center px-3 py-1.5 bg-blackbook-100 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-200 transition-colors">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit All
                </button>
                <!-- Done Editing Button (hidden initially) -->
                <button id="done-editing-btn"
                        onclick="exitEditAllMode()"
                        class="hidden inline-flex items-center px-3 py-1.5 bg-green-100 text-green-700 font-medium rounded-md hover:bg-green-200 transition-colors">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Done Editing
                </button>

                <!-- Delete Button -->
                <button onclick="confirmDelete()"
                        class="inline-flex items-center px-3 py-1.5 bg-blackbook-100 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-200 transition-colors">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete
                </button>
            </div>
        </div>

        <!-- Tags -->
        {% if organization.tags %}
        <div class="flex flex-wrap items-center gap-2 mt-4">
            {% for tag in organization.tags %}
            <span
                class="inline-flex items-center px-2.5 py-1 rounded text-sm font-medium"
                style="background-color: {{ tag.color or '#e2e8f0' }}20; color: {{ tag.color or '#475569' }}; border: 1px solid {{ tag.color or '#cbd5e1' }}40;"
            >
                {{ tag.name }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Main Content Sections -->
        <div class="lg:col-span-2 space-y-4">
            <!-- Description Section -->
            {% call collapsible_section('description', 'Description', open=true, edit_action='/api/organizations/' ~ organization.id ~ '/sections/description/edit') %}
            {% include "organizations/sections/_description_view.html" %}
            {% endcall %}

            <!-- Investment Profile Section (only for investment-related orgs) -->
            {% set investment_org_types = ['investment_firm', 'accelerator'] %}
            {% if organization.org_type.value in investment_org_types %}
            {% call collapsible_section('investment-profile', 'Investment Profile', open=true, edit_action='/api/organizations/' ~ organization.id ~ '/sections/investment-profile/edit') %}
            {% include "organizations/sections/_investment_profile_view.html" %}
            {% endcall %}
            {% endif %}

            <!-- People Section -->
            {% call collapsible_section('people', 'Affiliated People', open=true, edit_action='/api/organizations/' ~ organization.id ~ '/sections/people/edit') %}
            {% include "organizations/sections/_people_view.html" %}
            {% endcall %}

            <!-- Related Organizations Section -->
            {% call collapsible_section('related-orgs', 'Related Organizations', open=true, edit_action='/api/organizations/' ~ organization.id ~ '/sections/related-orgs/edit') %}
            {% include "organizations/sections/_related_orgs_view.html" %}
            {% endcall %}

            <!-- Interaction History Section -->
            {% call collapsible_section('interactions', 'Interaction History', open=true) %}
            {% include "organizations/sections/_interaction_history_view.html" %}
            {% endcall %}

            <!-- Notes Section -->
            {% call collapsible_section('notes', 'Notes', open=true, edit_action='/api/organizations/' ~ organization.id ~ '/sections/notes/edit') %}
            {% include "organizations/sections/_notes_view.html" %}
            {% endcall %}

            <!-- Office Locations Section -->
            {% call collapsible_section('offices', 'Office Locations', open=true, edit_action='/api/organizations/' ~ organization.id ~ '/sections/offices/edit') %}
            {% include "organizations/sections/_offices_view.html" %}
            {% endcall %}
        </div>

        <!-- Right Column: Sidebar -->
        <div class="space-y-4">
            <!-- Classification Section (Category/Type) -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-blackbook-900">Classification</h2>
                    <button type="button"
                            hx-get="/api/organizations/{{ organization.id }}/sections/classification/edit"
                            hx-target="#section-classification-content"
                            hx-swap="innerHTML"
                            class="section-edit-btn inline-flex items-center px-2 py-1 text-xs bg-blackbook-50 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-100">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Edit
                    </button>
                </div>
                <div id="section-classification-content">
                    {% include "organizations/sections/_classification_view.html" %}
                </div>
            </div>

            <!-- Links Section -->
            {% call collapsible_section('links', 'Links', open=true, edit_action='/api/organizations/' ~ organization.id ~ '/sections/links/edit') %}
            {% include "organizations/sections/_links_view.html" %}
            {% endcall %}

            <!-- My Relationship Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-blackbook-900">My Relationship</h2>
                    <button type="button"
                            hx-get="/api/organizations/{{ organization.id }}/sections/relationship-status/edit"
                            hx-target="#relationship-status-content"
                            hx-swap="innerHTML"
                            class="inline-flex items-center px-2 py-1 text-xs bg-blackbook-50 text-blackbook-700 font-medium rounded-md hover:bg-blackbook-100">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Edit
                    </button>
                </div>
                <div id="relationship-status-content">
                    {% include "organizations/sections/_relationship_status_view.html" %}
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-blackbook-900 mb-4">Summary</h2>
                <dl class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <dt class="text-blackbook-500">People</dt>
                        <dd class="text-blackbook-900 font-medium">{{ affiliated_persons | length }}</dd>
                    </div>
                    {% if outgoing_relationships is defined %}
                    <div class="flex justify-between">
                        <dt class="text-blackbook-500">Related Orgs</dt>
                        <dd class="text-blackbook-900 font-medium">{{ (outgoing_relationships | length) + (incoming_relationships | default([]) | length) }}</dd>
                    </div>
                    {% endif %}
                    {% if interactions is defined %}
                    <div class="flex justify-between">
                        <dt class="text-blackbook-500">Interactions</dt>
                        <dd class="text-blackbook-900 font-medium">{{ interaction_count or interactions | length }}</dd>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <dt class="text-blackbook-500">Tags</dt>
                        <dd class="text-blackbook-900 font-medium">{{ organization.tags | length }}</dd>
                    </div>
                    {% if organization.offices is defined %}
                    <div class="flex justify-between">
                        <dt class="text-blackbook-500">Offices</dt>
                        <dd class="text-blackbook-900 font-medium">{{ organization.offices | length }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- Record Info -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-blackbook-900 mb-4">Record Info</h2>
                <dl class="space-y-3 text-sm">
                    <div>
                        <dt class="text-blackbook-500">Created</dt>
                        <dd class="text-blackbook-900">{{ organization.created_at.strftime('%B %d, %Y') }}</dd>
                    </div>
                    <div>
                        <dt class="text-blackbook-500">Last Updated</dt>
                        <dd class="text-blackbook-900">{{ organization.updated_at.strftime('%B %d, %Y') }}</dd>
                    </div>
                    <div>
                        <dt class="text-blackbook-500">ID</dt>
                        <dd class="text-blackbook-500 font-mono text-xs">{{ organization.id }}</dd>
                    </div>
                    {% if organization.type_ref and organization.type_ref.profile_style %}
                    <div class="pt-3 border-t border-blackbook-200">
                        <dt class="text-blackbook-500">Profile Form</dt>
                        <dd>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                {{ organization.type_ref.profile_style|replace('_', ' ')|title }}
                            </span>
                        </dd>
                    </div>
                    {% elif organization.type_ref %}
                    <div class="pt-3 border-t border-blackbook-200">
                        <dt class="text-blackbook-500">Profile Form</dt>
                        <dd class="text-blackbook-400 text-xs">None (standard form)</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-blackbook-900 mb-2">Delete Organization</h3>
        <p class="text-blackbook-600 mb-4">
            Are you sure you want to delete <strong>{{ organization.name }}</strong>?
            This action cannot be undone.
        </p>
        <div class="flex justify-end gap-3">
            <button onclick="closeDeleteModal()"
                    class="px-4 py-2 text-blackbook-600 hover:text-blackbook-800 font-medium">
                Cancel
            </button>
            <button hx-delete="/organizations/{{ organization.id }}"
                    hx-target="body"
                    class="px-4 py-2 bg-red-600 text-white font-medium rounded-md hover:bg-red-700">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Logo Zoom Modal -->
{% if organization.logo %}
<div id="logo-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50" onclick="closeLogoModal()">
    <div class="relative max-w-4xl max-h-[90vh] p-4">
        <!-- Close button -->
        <button onclick="closeLogoModal()"
                class="absolute -top-2 -right-2 w-10 h-10 bg-white text-blackbook-700 rounded-full flex items-center justify-center shadow-lg hover:bg-blackbook-100 z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
        <img src="{{ organization.logo }}"
             alt="{{ organization.name }}"
             class="max-w-full max-h-[85vh] rounded-lg shadow-2xl object-contain bg-white p-4"
             onclick="event.stopPropagation()">
        <p class="text-white text-center mt-3 text-lg font-medium">{{ organization.name }}</p>
    </div>
</div>
{% endif %}

<script>
    function confirmDelete() {
        document.getElementById('delete-modal').classList.remove('hidden');
        document.getElementById('delete-modal').classList.add('flex');
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
        document.getElementById('delete-modal').classList.remove('flex');
    }

    // Logo modal functions
    function openLogoModal() {
        const modal = document.getElementById('logo-modal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    function closeLogoModal() {
        const modal = document.getElementById('logo-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
            closeLogoModal();
            closeAiSidebar();
        }
    });

    // Close modal on outside click
    document.getElementById('delete-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });

    // Edit All Mode - Triggers all section edit buttons at once
    function enterEditAllMode() {
        // Find and click all section edit buttons
        const editButtons = document.querySelectorAll('.section-edit-btn');
        console.log('Found edit buttons:', editButtons.length);
        editButtons.forEach(btn => {
            // Get the hx-get URL and target
            const url = btn.getAttribute('hx-get');
            const targetSelector = btn.getAttribute('hx-target');
            const target = document.querySelector(targetSelector);

            console.log('Triggering edit for:', url, '->', targetSelector);

            if (url && target) {
                // Directly issue the HTMX request
                htmx.ajax('GET', url, {target: target, swap: 'innerHTML'});
            }
        });

        // Toggle button visibility
        document.getElementById('edit-all-btn').classList.add('hidden');
        document.getElementById('done-editing-btn').classList.remove('hidden');
    }

    function exitEditAllMode() {
        // Reload the page to reset all sections to view mode
        // This ensures all data is fresh and in view state
        window.location.reload();
    }
</script>

<!-- AI Research Sidebar -->
{% with entity_type="organization", entity_id=organization.id, entity_name=organization.name %}
{% include "partials/_ai_sidebar.html" %}
{% endwith %}
{% endblock %}
