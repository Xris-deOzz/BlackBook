{% extends "base.html" %}

{% block breadcrumb %}
<nav class="bg-white border-b border-blackbook-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <ol class="flex items-center space-x-2 text-sm">
            <li>
                <a href="/" class="text-blackbook-500 hover:text-blackbook-700">Home</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li>
                <a href="/organizations" class="text-blackbook-500 hover:text-blackbook-700">Organizations</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li class="text-blackbook-900 font-medium">Merge Selected</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="/organizations" class="text-blackbook-500 hover:text-blackbook-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-blackbook-900">Merge {{ organizations|length }} Organizations</h1>
                <p class="text-blackbook-500">Select which organization to keep - others will be merged into it</p>
            </div>
        </div>
    </div>

    <form id="merge-form" method="POST" action="/organizations/merge/execute">
        <!-- Organization Selection Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for org in organizations %}
            <label class="cursor-pointer">
                <input type="radio" name="keep_id" value="{{ org.id }}" class="hidden peer" {% if loop.first %}checked{% endif %}>
                <input type="hidden" name="merge_ids" value="{{ org.id }}">
                <div class="bg-white rounded-lg shadow-md p-4 border-2 border-transparent peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blackbook-300 transition-colors">
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blackbook-100 text-blackbook-700 peer-checked:bg-blue-100 peer-checked:text-blue-700">
                            {% if loop.first %}Will Keep{% else %}Will Merge{% endif %}
                        </span>
                        <div class="w-5 h-5 rounded-full border-2 border-blackbook-300 peer-checked:border-blue-500 peer-checked:bg-blue-500 flex items-center justify-center">
                            <svg class="w-3 h-3 text-white hidden peer-checked:block" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 mb-3">
                        {% if org.logo %}
                        <img src="{{ org.logo }}" alt="{{ org.name }}"
                             class="w-12 h-12 rounded-lg object-cover border-2 border-blackbook-200">
                        {% else %}
                        <div class="w-12 h-12 rounded-lg bg-blackbook-200 flex items-center justify-center border-2 border-blackbook-300">
                            <svg class="w-6 h-6 text-blackbook-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                        </div>
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-blackbook-900 truncate">{{ org.name }}</h3>
                            {% if org.org_type %}
                            <p class="text-sm text-blackbook-500">{{ org.org_type.value|replace('_', ' ')|title }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-xs text-blackbook-500 space-y-2">
                        {% if org.website %}
                        <p class="truncate">{{ org.website|replace('https://', '')|replace('http://', '') }}</p>
                        {% endif %}

                        <!-- Data counts badges -->
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-0.5 bg-blackbook-100 rounded text-blackbook-600">
                                {{ org.tags|length }} tag{% if org.tags|length != 1 %}s{% endif %}
                            </span>
                            <span class="px-2 py-0.5 bg-blackbook-100 rounded text-blackbook-600">
                                {{ org.affiliated_persons|length }} people
                            </span>
                        </div>

                        <!-- Category -->
                        {% if org.category %}
                        <div class="mt-2 pt-2 border-t border-blackbook-200">
                            <p class="font-medium text-blackbook-600 mb-1">Category:</p>
                            <p class="text-blackbook-500">{{ org.category }}</p>
                        </div>
                        {% endif %}

                        <!-- Description preview -->
                        {% if org.description %}
                        <div class="mt-2 pt-2 border-t border-blackbook-200">
                            <p class="font-medium text-blackbook-600 mb-1">Description:</p>
                            <p class="text-blackbook-500 line-clamp-2">{{ org.description[:100] }}{% if org.description|length > 100 %}...{% endif %}</p>
                        </div>
                        {% endif %}

                        <!-- Notes preview -->
                        {% if org.notes %}
                        <div class="mt-2 pt-2 border-t border-blackbook-200">
                            <p class="font-medium text-blackbook-600 mb-1">Notes:</p>
                            <p class="text-blackbook-500 line-clamp-2">{{ org.notes[:100] }}{% if org.notes|length > 100 %}...{% endif %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </label>
            {% endfor %}
        </div>

        <!-- Field Selection - Choose which values to keep -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-blackbook-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blackbook-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Field Selection
                </h2>
                <span class="text-sm text-blackbook-500">Choose which value to keep for each field</span>
            </div>

            <p class="text-sm text-blackbook-600 mb-4">
                For each field below, select which organization's value you want to keep in the merged record. Fields with no value from any organization are hidden.
            </p>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-blackbook-200">
                    <thead class="bg-blackbook-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-blackbook-500 uppercase tracking-wider w-40">Field</th>
                            {% for org in organizations %}
                            <th class="px-4 py-3 text-left text-xs font-medium text-blackbook-500 uppercase tracking-wider">
                                {{ org.name|truncate(20) }}
                                {% if loop.first %}<span class="ml-1 text-blue-500">(default)</span>{% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-blackbook-200">
                        <!-- Name -->
                        {% set has_values = organizations|selectattr('name')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Name</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_name" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900">{{ org.name or '-' }}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Type -->
                        {% set has_values = organizations|selectattr('org_type')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Type</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_org_type" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900">{{ org.org_type.value|replace('_', ' ')|title if org.org_type else '-' }}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Category -->
                        {% set has_values = organizations|selectattr('category')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Category</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_category" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900">{{ org.category or '-' }}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Logo -->
                        {% set has_values = organizations|selectattr('logo')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Logo</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_logo" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    {% if org.logo %}
                                    <img src="{{ org.logo }}" alt="Logo" class="w-8 h-8 rounded object-cover">
                                    {% else %}
                                    <span class="text-sm text-blackbook-400">-</span>
                                    {% endif %}
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Description -->
                        {% set has_values = organizations|selectattr('description')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Description</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_description" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900 line-clamp-2">{{ org.description[:80] if org.description else '-' }}{% if org.description and org.description|length > 80 %}...{% endif %}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Website -->
                        {% set has_values = organizations|selectattr('website')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Website</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_website" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900 truncate max-w-[200px]">{{ org.website or '-' }}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Crunchbase -->
                        {% set has_values = organizations|selectattr('crunchbase')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Crunchbase</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_crunchbase" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900 truncate max-w-[200px]">{{ org.crunchbase or '-' }}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Priority Rank -->
                        {% set has_values = organizations|selectattr('priority_rank')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Priority Rank</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_priority_rank" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900">{{ org.priority_rank }}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}

                        <!-- Notes -->
                        {% set has_values = organizations|selectattr('notes')|list|length > 0 %}
                        {% if has_values %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-blackbook-700">Notes</td>
                            {% for org in organizations %}
                            <td class="px-4 py-3">
                                <label class="flex items-start space-x-2 cursor-pointer">
                                    <input type="radio" name="field_notes" value="{{ org.id }}"
                                           {% if loop.first %}checked{% endif %}
                                           class="mt-1 h-4 w-4 text-blue-600 border-blackbook-300 focus:ring-blue-500">
                                    <span class="text-sm text-blackbook-900 line-clamp-2">{{ org.notes[:80] if org.notes else '-' }}{% if org.notes and org.notes|length > 80 %}...{% endif %}</span>
                                </label>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Notes combination option -->
            {% set has_notes = organizations|selectattr('notes')|list|length > 1 %}
            {% if has_notes %}
            <div class="mt-4 p-4 bg-blackbook-50 rounded-lg">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" name="combine_notes" value="true"
                           class="h-4 w-4 text-blue-600 border-blackbook-300 rounded focus:ring-blue-500">
                    <div>
                        <span class="text-sm font-medium text-blackbook-700">Combine all notes</span>
                        <p class="text-xs text-blackbook-500">If checked, notes from all organizations will be merged together</p>
                    </div>
                </label>
            </div>
            {% endif %}
        </div>

        <!-- Summary Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-lg font-semibold text-blackbook-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blackbook-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                </svg>
                What Will Be Merged
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Tags -->
                <div class="p-4 bg-blackbook-50 rounded-lg">
                    <h3 class="font-medium text-blackbook-700 mb-2">Tags</h3>
                    <p class="text-sm text-blackbook-600">All tags will be combined (duplicates removed)</p>
                    <div class="mt-2 flex flex-wrap gap-1">
                        {% set all_tags = [] %}
                        {% for org in organizations %}
                            {% for tag in org.tags %}
                                {% if tag.name not in all_tags %}
                                    {% set _ = all_tags.append(tag.name) %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {% for tag_name in all_tags[:5] %}
                        <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded">{{ tag_name }}</span>
                        {% endfor %}
                        {% if all_tags|length > 5 %}
                        <span class="px-2 py-0.5 text-xs bg-blackbook-200 text-blackbook-600 rounded">+{{ all_tags|length - 5 }} more</span>
                        {% endif %}
                    </div>
                </div>

                <!-- People (Unified Section) -->
                <div class="p-4 bg-blackbook-50 rounded-lg">
                    <h3 class="font-medium text-blackbook-700 mb-2">People</h3>
                    <p class="text-sm text-blackbook-600 mb-2">All person affiliations will be automatically transferred</p>
                    {% set total_people = namespace(count=0) %}
                    {% for org in organizations %}{% set total_people.count = total_people.count + org.affiliated_persons|length %}{% endfor %}
                    <p class="text-lg font-semibold text-blackbook-800">{{ total_people.count }} total</p>
                    {% if total_people.count > 0 %}
                    <div class="mt-2 max-h-40 overflow-y-auto text-xs space-y-1">
                        {% for org in organizations %}
                            {% for po in org.affiliated_persons %}
                            <div class="flex items-center gap-1 text-blackbook-600">
                                <span class="font-medium">{{ po.person.full_name if po.person else po.person_name or 'Unknown' }}</span>
                                <span class="text-blackbook-400">- {{ po.relationship.value|replace('_', ' ')|title }}</span>
                                {% if po.role %}<span class="text-blackbook-400">({{ po.role }})</span>{% endif %}
                                <span class="text-blackbook-300">(from {{ org.name|truncate(15) }})</span>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-4 mt-6">
            <a href="/organizations" class="px-4 py-2 text-blackbook-600 hover:text-blackbook-800 font-medium">
                Cancel
            </a>
            <button type="button" onclick="confirmMerge()"
                    class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
                Merge {{ organizations|length }} Organizations
            </button>
        </div>
    </form>
</div>

<!-- Confirmation Modal -->
<div id="merge-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-blackbook-900 mb-2">Confirm Merge</h3>
        <p class="text-blackbook-600 mb-4">
            Merge <strong>{{ organizations|length - 1 }}</strong> organization{% if organizations|length > 2 %}s{% endif %} into the selected organization?
        </p>
        <p class="text-sm text-blackbook-500 mb-4">
            All data will be transferred to the kept organization, and the others will be deleted.
        </p>
        <div class="flex justify-end gap-3">
            <button onclick="closeMergeModal()"
                    class="px-4 py-2 text-blackbook-600 hover:text-blackbook-800 font-medium">
                Cancel
            </button>
            <button id="confirm-merge-btn"
                    onclick="executeMerge()"
                    class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
                Merge
            </button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 transform translate-y-20 transition-transform duration-300 z-50">
    <div class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span id="toast-message">Merged successfully!</span>
    </div>
</div>

<script>
    function confirmMerge() {
        document.getElementById('merge-modal').classList.remove('hidden');
        document.getElementById('merge-modal').classList.add('flex');
    }

    function closeMergeModal() {
        document.getElementById('merge-modal').classList.add('hidden');
        document.getElementById('merge-modal').classList.remove('flex');
    }

    async function executeMerge() {
        const btn = document.getElementById('confirm-merge-btn');
        btn.disabled = true;
        btn.textContent = 'Merging...';

        const form = document.getElementById('merge-form');
        const formData = new FormData(form);

        try {
            const response = await fetch('/organizations/merge/execute', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                closeMergeModal();
                showToast(`Merged ${data.merged_count} organization(s) successfully!`, 'success');
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
            } else {
                showToast(data.detail || 'Merge failed', 'error');
                btn.disabled = false;
                btn.textContent = 'Merge';
            }
        } catch (error) {
            showToast('An error occurred', 'error');
            btn.disabled = false;
            btn.textContent = 'Merge';
        }
    }

    function showToast(message, type) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastDiv = toast.querySelector('div');

        toastMessage.textContent = message;

        if (type === 'error') {
            toastDiv.classList.remove('bg-green-600');
            toastDiv.classList.add('bg-red-600');
        } else {
            toastDiv.classList.remove('bg-red-600');
            toastDiv.classList.add('bg-green-600');
        }

        toast.classList.remove('translate-y-20');

        setTimeout(() => {
            toast.classList.add('translate-y-20');
        }, 3000);
    }

    // Update labels when selection changes
    document.querySelectorAll('input[name="keep_id"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('input[name="keep_id"]').forEach(r => {
                const label = r.closest('label').querySelector('span');
                if (r.checked) {
                    label.textContent = 'Will Keep';
                    label.classList.remove('bg-blackbook-100', 'text-blackbook-700');
                    label.classList.add('bg-blue-100', 'text-blue-700');
                } else {
                    label.textContent = 'Will Merge';
                    label.classList.remove('bg-blue-100', 'text-blue-700');
                    label.classList.add('bg-blackbook-100', 'text-blackbook-700');
                }
            });
        });
    });

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeMergeModal();
        }
    });

    // Close modal on outside click
    document.getElementById('merge-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeMergeModal();
        }
    });
</script>
{% endblock %}
