{# Organization Classification Section - Edit Mode with Cascading Dropdowns #}
<form id="org-classification-form"
      hx-put="/api/organizations/{{ organization.id }}/sections/classification"
      hx-target="#section-classification-content"
      hx-swap="innerHTML"
      class="space-y-4">

    {# Category Dropdown #}
    <div>
        <label for="category_id" class="block text-sm font-medium text-blackbook-700 mb-1">Category</label>
        <select name="category_id"
                id="category_id"
                class="w-full px-3 py-2 border border-blackbook-300 rounded-md text-sm focus:ring-2 focus:ring-blackbook-500 focus:border-blackbook-500"
                onchange="updateTypeDropdown()">
            <option value="">-- Select Category --</option>
            {% for category in categories %}
            <option value="{{ category.id }}"
                    {% if organization.category_id == category.id %}selected{% endif %}>
                {{ category.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    {# Type Dropdown (cascading based on category) #}
    <div>
        <label for="type_id" class="block text-sm font-medium text-blackbook-700 mb-1">Type</label>
        <select name="type_id"
                id="type_id"
                class="w-full px-3 py-2 border border-blackbook-300 rounded-md text-sm focus:ring-2 focus:ring-blackbook-500 focus:border-blackbook-500">
            <option value="">-- Select Type --</option>
            {% for type in types %}
            <option value="{{ type.id }}"
                    data-category="{{ type.category_id }}"
                    data-profile-style="{{ type.profile_style or '' }}"
                    {% if organization.type_id == type.id %}selected{% endif %}>
                {{ type.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    {# Profile Style Display (read-only, auto-populated) #}
    <div id="profile-style-display" class="{% if not organization.type_ref or not organization.type_ref.profile_style %}hidden{% endif %}">
        <label class="block text-sm font-medium text-blackbook-700 mb-1">Profile Form</label>
        <div class="px-3 py-2 bg-blackbook-50 border border-blackbook-200 rounded-md text-sm text-blackbook-600">
            <span id="profile-style-text">
                {% if organization.type_ref and organization.type_ref.profile_style %}
                {{ organization.type_ref.profile_style|replace('_', ' ')|title }}
                {% else %}
                Standard Form
                {% endif %}
            </span>
            <span class="text-blackbook-400 text-xs ml-2">(automatically determined by type)</span>
        </div>
    </div>

    <div class="flex justify-end gap-2 pt-2">
        <button type="button"
                hx-get="/api/organizations/{{ organization.id }}/sections/classification/view"
                hx-target="#section-classification-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 text-sm text-blackbook-600 hover:text-blackbook-800">
            Cancel
        </button>
        <button type="submit"
                class="px-3 py-1.5 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700">
            Save
        </button>
    </div>
</form>

<script>
// Types data passed from server
const typesByCategory = {{ types_by_category|tojson|safe }};

function updateTypeDropdown() {
    const categorySelect = document.getElementById('category_id');
    const typeSelect = document.getElementById('type_id');
    const selectedCategoryId = categorySelect.value;
    const currentTypeId = typeSelect.value;

    // Show/hide type options based on category
    const options = typeSelect.querySelectorAll('option');
    let firstMatchingOption = null;
    let hasSelectedOption = false;

    options.forEach(option => {
        if (option.value === '') {
            option.style.display = ''; // Always show the placeholder
            return;
        }

        const optionCategory = option.getAttribute('data-category');
        if (!selectedCategoryId || optionCategory === selectedCategoryId) {
            option.style.display = '';
            if (!firstMatchingOption) firstMatchingOption = option;
            if (option.value === currentTypeId) hasSelectedOption = true;
        } else {
            option.style.display = 'none';
        }
    });

    // If current selection is not valid for new category, reset
    if (!hasSelectedOption && selectedCategoryId) {
        typeSelect.value = '';
    }

    updateProfileStyleDisplay();
}

function updateProfileStyleDisplay() {
    const typeSelect = document.getElementById('type_id');
    const selectedOption = typeSelect.options[typeSelect.selectedIndex];
    const profileStyleDisplay = document.getElementById('profile-style-display');
    const profileStyleText = document.getElementById('profile-style-text');

    if (selectedOption && selectedOption.value) {
        const profileStyle = selectedOption.getAttribute('data-profile-style');
        if (profileStyle) {
            profileStyleText.textContent = profileStyle.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            profileStyleDisplay.classList.remove('hidden');
        } else {
            profileStyleText.textContent = 'Standard Form';
            profileStyleDisplay.classList.add('hidden');
        }
    } else {
        profileStyleDisplay.classList.add('hidden');
    }
}

// Add event listener for type dropdown change
document.getElementById('type_id').addEventListener('change', updateProfileStyleDisplay);

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    updateTypeDropdown();
});

// Also run immediately for HTMX-loaded content
updateTypeDropdown();
</script>
