{% if no_accounts %}
<div class="text-center py-8 text-blackbook-400">
    <svg class="mx-auto h-12 w-12 text-blackbook-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
    </svg>
    <p class="mt-2 text-sm">No Google account connected</p>
    <a href="/settings#google-accounts" class="mt-2 inline-block text-sm text-blue-400 hover:text-blue-300">
        Connect Google Account
    </a>
</div>
{% elif error %}
<div class="text-center py-8 text-blackbook-400">
    <svg class="mx-auto h-12 w-12 text-blackbook-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <p class="mt-2 text-sm">{{ error }}</p>
</div>
{% elif days is defined and days|length > 0 %}
<div id="tasks-list-container">
    <!-- URGENT Section (Overdue tasks) -->
    {% if overdue_tasks %}
    <div class="mb-4 bg-red-900/20 rounded-lg p-3">
        <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-xs font-medium uppercase tracking-wider text-red-400">OVERDUE</span>
            <span class="bg-red-600 text-white text-xs font-bold px-1.5 py-0.5 rounded">{{ overdue_tasks|length }}</span>
        </div>
        <div class="flex flex-wrap gap-2">
            {% for task in overdue_tasks %}
            <div class="task-item task-urgent flex items-center gap-2 px-3 py-2 bg-red-900/40 rounded-lg cursor-pointer hover:bg-red-900/60 border-l-4 border-red-500"
                 data-list-id="{{ task.list_id }}"
                 data-task-id="{{ task.id }}"
                 data-title="{{ task.title|e }}"
                 data-notes="{{ task.notes|e }}"
                 data-due-date="{{ task.due_date or '' }}"
                 data-due-time="{{ task.due_time or '' }}"
                 data-list-name="{{ task.list_name|e }}">
                <button type="button" class="task-toggle flex-shrink-0 w-5 h-5 rounded-full border-2 border-red-500 hover:bg-red-500/30 transition-all flex items-center justify-center group/check"
                        title="Mark as complete">
                    <svg class="w-3 h-3 text-white opacity-0 group-hover/check:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                    </svg>
                </button>
                <div class="task-content flex-1 min-w-0">
                    <span class="text-sm text-blackbook-100 truncate">{{ task.title }}</span>
                    <span class="text-xs text-red-400 ml-2">{{ task.due_date_display }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Week Days - Horizontal Scrolling Columns with snap on mobile -->
    <div class="flex gap-2 sm:gap-3 overflow-x-auto pb-2 snap-x snap-mandatory lg:snap-none -mx-2 px-2 sm:mx-0 sm:px-0" style="min-height: 400px;" id="week-days-container">
        {% for day in days %}
        <div class="day-column flex-shrink-0 w-[70vw] sm:w-[45vw] lg:w-64 min-w-[200px] bg-blackbook-700/30 rounded-lg flex flex-col transition-all snap-start"
             data-date="{{ day.date_str }}">
            <!-- Day Header -->
            <div class="p-3 border-b border-blackbook-600 {% if day.is_today %}bg-cyan-900/30{% endif %}">
                <div class="text-xs text-blackbook-500">{{ day.display_date }}</div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold {% if day.is_today %}text-cyan-400{% else %}text-blackbook-200{% endif %}">
                        {{ day.day_name }}
                    </span>
                    <span class="day-task-count {% if day.is_today %}bg-cyan-600{% else %}bg-blackbook-600{% endif %} text-white text-xs font-bold px-1.5 py-0.5 rounded">
                        {{ day.task_count }}
                    </span>
                </div>
            </div>

            <!-- Day Tasks (Drop Zone) -->
            <div class="day-tasks-zone flex-1 p-2 space-y-1 overflow-y-auto max-h-[350px]">
                {% if day.tasks %}
                {% for task in day.tasks %}
                <div class="task-item flex items-start gap-2 sm:gap-1 p-3 sm:p-2 rounded-lg group cursor-pointer hover:bg-blackbook-700/50 transition-all min-h-[44px]"
                     draggable="true"
                     data-list-id="{{ task.list_id }}"
                     data-task-id="{{ task.id }}"
                     data-title="{{ task.title|e }}"
                     data-notes="{{ task.notes|e }}"
                     data-due-date="{{ task.due_date or '' }}"
                     data-due-time="{{ task.due_time or '' }}"
                     data-list-name="{{ task.list_name|e }}">
                    <!-- Drag Handle - hidden on mobile -->
                    <div class="task-drag-handle hidden sm:block flex-shrink-0 mt-1 cursor-grab active:cursor-grabbing text-blackbook-500 hover:text-blackbook-300 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                            <circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/>
                            <circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/>
                            <circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/>
                        </svg>
                    </div>
                    <button type="button" class="task-toggle flex-shrink-0 mt-0.5 w-6 h-6 sm:w-5 sm:h-5 rounded-full border-2 {% if day.is_today %}border-cyan-500 hover:bg-cyan-500/30{% else %}border-blackbook-500 hover:bg-blackbook-500/30{% endif %} transition-all flex items-center justify-center group/check"
                            title="Mark as complete">
                        <svg class="w-3 h-3 text-white opacity-0 group-hover/check:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0 task-content">
                        <p class="text-sm text-blackbook-100">{{ task.title }}</p>
                        <div class="flex items-center gap-2 text-xs text-blackbook-500 truncate">
                            <span>{{ task.list_name }}</span>
                            {% if task.due_time_display %}
                            <span class="text-cyan-400">@ {{ task.due_time_display }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex-shrink-0 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <button type="button" class="p-2 sm:p-1 text-blackbook-400 hover:text-blackbook-200 task-edit">
                            <svg class="w-5 h-5 sm:w-4 sm:h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-day-placeholder text-center py-6 text-blackbook-500">
                    <svg class="mx-auto h-6 w-6 text-green-600 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-xs">No tasks</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Edit Modal - Full screen on mobile -->
<div id="task-edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center">
    <div class="bg-blackbook-800 rounded-t-xl sm:rounded-lg p-4 w-full sm:max-w-md sm:mx-4 border border-blackbook-600 h-[90vh] sm:h-auto sm:max-h-[90vh] overflow-y-auto flex flex-col">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-blackbook-100">Edit Task</h3>
            <span id="edit-list-name-display" class="text-xs text-blackbook-400 bg-blackbook-700 px-2 py-1 rounded"></span>
        </div>
        <form id="task-edit-form" class="space-y-3">
            <input type="hidden" id="edit-list-id">
            <input type="hidden" id="edit-task-id">
            <div>
                <label class="block text-xs text-blackbook-400 mb-1">Title</label>
                <input type="text" id="edit-title"
                       class="w-full px-3 py-2 text-sm bg-blackbook-700 border border-blackbook-600 rounded text-blackbook-100 focus:outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-blackbook-400 mb-1">Notes</label>
                <textarea id="edit-notes" rows="3"
                          class="w-full px-3 py-2 text-sm bg-blackbook-700 border border-blackbook-600 rounded text-blackbook-300 focus:outline-none focus:border-blue-500"></textarea>
            </div>
            <!-- Due Date & Time -->
            <div>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-xs text-blackbook-400 mb-1">Due Date</label>
                        <input type="date" id="edit-due-date"
                               class="w-full px-3 py-2 text-sm bg-blackbook-700 border border-blackbook-600 rounded text-blackbook-100 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="w-28">
                        <label class="block text-xs text-blackbook-400 mb-1">Time <span class="text-blackbook-500">(opt)</span></label>
                        <input type="time" id="edit-due-time"
                               class="w-full px-3 py-2 text-sm bg-blackbook-700 border border-blackbook-600 rounded text-blackbook-100 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-2">
                    <button type="button" onclick="setEditQuickDate(0)"
                            class="px-2 py-1 text-xs bg-blackbook-700 text-blackbook-300 rounded hover:bg-blackbook-600 border border-blackbook-600">Today</button>
                    <button type="button" onclick="setEditQuickDate(1)"
                            class="px-2 py-1 text-xs bg-blackbook-700 text-blackbook-300 rounded hover:bg-blackbook-600 border border-blackbook-600">Tmrw</button>
                    <button type="button" onclick="setEditQuickDate(7)"
                            class="px-2 py-1 text-xs bg-blackbook-700 text-blackbook-300 rounded hover:bg-blackbook-600 border border-blackbook-600">+1Wk</button>
                    <span class="border-l border-blackbook-600 mx-1"></span>
                    <button type="button" onclick="setEditQuickTime('09:00')"
                            class="px-2 py-1 text-xs bg-blackbook-700 text-cyan-400 rounded hover:bg-blackbook-600 border border-blackbook-600">9am</button>
                    <button type="button" onclick="setEditQuickTime('14:00')"
                            class="px-2 py-1 text-xs bg-blackbook-700 text-cyan-400 rounded hover:bg-blackbook-600 border border-blackbook-600">2pm</button>
                    <button type="button" onclick="setEditQuickTime('17:00')"
                            class="px-2 py-1 text-xs bg-blackbook-700 text-cyan-400 rounded hover:bg-blackbook-600 border border-blackbook-600">5pm</button>
                    <button type="button" id="clear-due-date"
                            class="px-2 py-1 text-xs text-blackbook-400 hover:text-blackbook-200 border border-blackbook-600 rounded">Clear</button>
                </div>
            </div>
            <div class="flex gap-2 pt-2">
                <button type="submit"
                        class="flex-1 px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                    Save
                </button>
                <button type="button" id="cancel-edit"
                        class="flex-1 px-4 py-2 text-sm bg-blackbook-700 text-blackbook-300 rounded hover:bg-blackbook-600">
                    Cancel
                </button>
            </div>
            <!-- Add subtask button -->
            <div class="border-t border-blackbook-600 pt-3 mt-3">
                <button type="button" id="add-subtask-from-edit"
                        class="w-full px-4 py-2 text-sm bg-blackbook-700 text-cyan-400 rounded hover:bg-blackbook-600 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Subtask
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const container = document.getElementById('tasks-list-container');
    if (!container) return;

    const currentView = '{{ view }}';

    // Update task count in header
    const totalCount = {{ total_tasks|default(0) }};
    const countEl = document.getElementById('today-task-count');
    if (countEl) {
        countEl.textContent = totalCount;
        countEl.className = totalCount > 0
            ? 'bg-amber-500 text-white text-xs font-bold px-1.5 py-0.5 rounded'
            : 'bg-blackbook-600 text-blackbook-400 text-xs font-bold px-1.5 py-0.5 rounded';
    }

    // ========== DRAG AND DROP ==========
    let draggedTask = null;
    let taskPlaceholder = null;
    let sourceColumn = null;

    function initTaskDrag() {
        const taskItems = container.querySelectorAll('.task-item');
        taskItems.forEach(task => {
            task.addEventListener('dragstart', onTaskDragStart);
            task.addEventListener('dragend', onTaskDragEnd);
        });

        // Add drop zones to day columns
        const dropZones = container.querySelectorAll('.day-tasks-zone');
        dropZones.forEach(zone => {
            zone.addEventListener('dragover', onTaskDragOver);
            zone.addEventListener('drop', onTaskDrop);
            zone.addEventListener('dragleave', onTaskDragLeave);
        });
    }

    function onTaskDragStart(e) {
        draggedTask = e.target.closest('.task-item');
        if (!draggedTask) return;

        sourceColumn = draggedTask.closest('.day-column');

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', JSON.stringify({
            listId: draggedTask.dataset.listId,
            taskId: draggedTask.dataset.taskId,
            dueDate: draggedTask.dataset.dueDate
        }));

        // Create placeholder
        taskPlaceholder = document.createElement('div');
        taskPlaceholder.className = 'task-placeholder border-2 border-dashed border-cyan-500/50 rounded-lg h-14 my-1 bg-cyan-500/10';

        // Style dragged task
        setTimeout(() => {
            if (draggedTask) {
                draggedTask.style.opacity = '0.4';
                draggedTask.classList.add('scale-95');
            }
        }, 0);
    }

    function onTaskDragEnd(e) {
        if (draggedTask) {
            draggedTask.style.opacity = '';
            draggedTask.classList.remove('scale-95');
        }
        if (taskPlaceholder && taskPlaceholder.parentNode) {
            taskPlaceholder.remove();
        }

        // Remove drop highlights
        container.querySelectorAll('.day-column').forEach(col => {
            col.classList.remove('ring-2', 'ring-cyan-500/50');
        });

        draggedTask = null;
        taskPlaceholder = null;
        sourceColumn = null;
    }

    function onTaskDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        if (!draggedTask || !taskPlaceholder) return;

        const dropZone = e.target.closest('.day-tasks-zone');
        if (!dropZone) return;

        const column = dropZone.closest('.day-column');
        if (column) {
            // Highlight the column
            container.querySelectorAll('.day-column').forEach(col => {
                col.classList.remove('ring-2', 'ring-cyan-500/50');
            });
            column.classList.add('ring-2', 'ring-cyan-500/50');
        }

        // Hide empty placeholder if present
        const emptyPlaceholder = dropZone.querySelector('.empty-day-placeholder');
        if (emptyPlaceholder) {
            emptyPlaceholder.style.display = 'none';
        }

        // Find insert position based on mouse Y
        const taskItems = Array.from(dropZone.querySelectorAll('.task-item:not([style*="opacity: 0.4"])'));
        let insertBefore = null;

        for (const item of taskItems) {
            const rect = item.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            if (e.clientY < midY) {
                insertBefore = item;
                break;
            }
        }

        // Move placeholder
        if (insertBefore) {
            if (taskPlaceholder.nextSibling !== insertBefore) {
                dropZone.insertBefore(taskPlaceholder, insertBefore);
            }
        } else {
            if (!dropZone.contains(taskPlaceholder) || taskPlaceholder.nextSibling) {
                dropZone.appendChild(taskPlaceholder);
            }
        }
    }

    function onTaskDragLeave(e) {
        const relatedTarget = e.relatedTarget;
        const dropZone = e.currentTarget;

        // Only act if truly leaving the drop zone
        if (!relatedTarget || !dropZone.contains(relatedTarget)) {
            const column = dropZone.closest('.day-column');
            if (column && column !== sourceColumn) {
                column.classList.remove('ring-2', 'ring-cyan-500/50');
            }

            // Show empty placeholder again if no tasks
            const emptyPlaceholder = dropZone.querySelector('.empty-day-placeholder');
            const hasTasks = dropZone.querySelectorAll('.task-item').length > 0;
            if (emptyPlaceholder && !hasTasks) {
                emptyPlaceholder.style.display = '';
            }
        }
    }

    async function onTaskDrop(e) {
        e.preventDefault();

        if (!draggedTask || !taskPlaceholder) return;

        const dropZone = e.target.closest('.day-tasks-zone');
        if (!dropZone) return;

        const targetColumn = dropZone.closest('.day-column');
        if (!targetColumn) return;

        const listId = draggedTask.dataset.listId;
        const taskId = draggedTask.dataset.taskId;
        const oldDueDate = draggedTask.dataset.dueDate;
        const newDueDate = targetColumn.dataset.date;

        // Move task in UI immediately
        if (taskPlaceholder.parentNode) {
            taskPlaceholder.parentNode.insertBefore(draggedTask, taskPlaceholder);
            taskPlaceholder.remove();
        }

        // Reset drag state
        draggedTask.style.opacity = '';
        draggedTask.classList.remove('scale-95');
        container.querySelectorAll('.day-column').forEach(col => {
            col.classList.remove('ring-2', 'ring-cyan-500/50');
        });

        // Hide empty placeholder if we added a task
        const emptyPlaceholder = dropZone.querySelector('.empty-day-placeholder');
        if (emptyPlaceholder) {
            emptyPlaceholder.style.display = 'none';
        }

        // Update data attribute
        draggedTask.dataset.dueDate = newDueDate;

        // Only call API if date changed
        if (oldDueDate !== newDueDate) {
            try {
                const response = await fetch(`/tasks/${listId}/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ due_date: newDueDate })
                });

                if (response.ok) {
                    // Refresh to get proper state
                    setTimeout(() => {
                        htmx.ajax('GET', `/dashboard/tasks-panel?view=${currentView}`, {target: '#tasks-panel-content', swap: 'innerHTML'});
                    }, 300);
                } else {
                    console.error('Failed to update task due date');
                    htmx.ajax('GET', `/dashboard/tasks-panel?view=${currentView}`, {target: '#tasks-panel-content', swap: 'innerHTML'});
                }
            } catch (error) {
                console.error('Error updating task:', error);
                htmx.ajax('GET', `/dashboard/tasks-panel?view=${currentView}`, {target: '#tasks-panel-content', swap: 'innerHTML'});
            }
        }

        draggedTask = null;
        taskPlaceholder = null;
        sourceColumn = null;
    }

    // Initialize drag and drop
    initTaskDrag();

    // ========== TASK TOGGLE (COMPLETE) ==========
    container.querySelectorAll('.task-toggle').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const taskItem = btn.closest('.task-item');
            const listId = taskItem.dataset.listId;
            const taskId = taskItem.dataset.taskId;

            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 animate-spin text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                const response = await fetch(`/tasks/${listId}/${taskId}/toggle`, { method: 'POST' });
                if (response.ok) {
                    setTimeout(() => {
                        htmx.ajax('GET', `/dashboard/tasks-panel?view=${currentView}`, {target: '#tasks-panel-content', swap: 'innerHTML'});
                    }, 300);
                }
            } catch (error) {
                console.error('Error toggling task:', error);
            }
        });
    });

    // ========== TASK EDIT MODAL ==========
    const modal = document.getElementById('task-edit-modal');
    const form = document.getElementById('task-edit-form');

    container.querySelectorAll('.task-edit, .task-content').forEach(el => {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            const taskItem = el.closest('.task-item');
            document.getElementById('edit-list-id').value = taskItem.dataset.listId;
            document.getElementById('edit-task-id').value = taskItem.dataset.taskId;
            document.getElementById('edit-title').value = taskItem.dataset.title;
            document.getElementById('edit-notes').value = taskItem.dataset.notes;
            document.getElementById('edit-due-date').value = taskItem.dataset.dueDate;
            document.getElementById('edit-due-time').value = taskItem.dataset.dueTime || '';
            document.getElementById('edit-list-name-display').textContent = taskItem.dataset.listName || '';
            modal.classList.remove('hidden');
            document.getElementById('edit-title').focus();
        });
    });

    // Add subtask button - opens the add task modal with parent ID
    document.getElementById('add-subtask-from-edit')?.addEventListener('click', () => {
        const listId = document.getElementById('edit-list-id').value;
        const parentId = document.getElementById('edit-task-id').value;
        closeModal();
        // Load the add task modal with parent ID
        htmx.ajax('GET', `/dashboard/add-task-modal?parent_task_id=${parentId}&list_id=${listId}`, {target: '#add-task-modal-container', swap: 'innerHTML'});
    });

    function closeModal() {
        modal.classList.add('hidden');
    }

    // Quick date setter for edit modal - expose globally
    window.setEditQuickDate = function(daysFromToday) {
        const date = new Date();
        date.setDate(date.getDate() + daysFromToday);
        document.getElementById('edit-due-date').value = date.toISOString().split('T')[0];
    };

    // Quick time setter for edit modal - expose globally
    window.setEditQuickTime = function(time) {
        document.getElementById('edit-due-time').value = time;
    };

    document.getElementById('cancel-edit')?.addEventListener('click', closeModal);
    document.getElementById('clear-due-date')?.addEventListener('click', () => {
        document.getElementById('edit-due-date').value = '';
        document.getElementById('edit-due-time').value = '';
    });
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) closeModal();
    });

    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const listId = document.getElementById('edit-list-id').value;
        const taskId = document.getElementById('edit-task-id').value;
        const title = document.getElementById('edit-title').value;
        const notes = document.getElementById('edit-notes').value;
        const dueDate = document.getElementById('edit-due-date').value;
        const dueTime = document.getElementById('edit-due-time').value;

        try {
            const response = await fetch(`/tasks/${listId}/${taskId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, notes, due_date: dueDate || null, due_time: dueTime || null })
            });
            if (response.ok) {
                closeModal();
                htmx.ajax('GET', `/dashboard/tasks-panel?view=${currentView}`, {target: '#tasks-panel-content', swap: 'innerHTML'});
            }
        } catch (error) {
            console.error('Error saving task:', error);
        }
    });
})();
</script>
{% else %}
<!-- Empty state - no days data -->
<div class="text-center py-12 text-blackbook-400">
    <svg class="mx-auto h-12 w-12 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <p class="mt-2 text-sm">No tasks this week</p>
    <p class="text-xs text-blackbook-500">You're all caught up!</p>
</div>
<script>
    const countEl = document.getElementById('today-task-count');
    if (countEl) {
        countEl.textContent = '0';
        countEl.className = 'bg-blackbook-600 text-blackbook-400 text-xs font-bold px-1.5 py-0.5 rounded';
    }
</script>
{% endif %}
