{% extends "base.html" %}
{% from "partials/_components.html" import collapsible_section %}

{% block breadcrumb %}
<nav class="bg-white border-b border-blackbook-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <ol class="flex items-center space-x-2 text-sm">
            <li>
                <a href="/" class="text-blackbook-500 hover:text-blackbook-700">Home</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li>
                <a href="/people" class="text-blackbook-500 hover:text-blackbook-700">People</a>
            </li>
            <li>
                <svg class="h-4 w-4 text-blackbook-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </li>
            <li class="text-blackbook-900 font-medium">New Person</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<form hx-post="/people" hx-target="body" hx-swap="innerHTML" id="person-form" class="space-y-6">
    <!-- Header with Back Button, Profile Picture, and Title -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="/people" class="text-blackbook-500 hover:text-blackbook-700">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>

            {# Profile Picture Upload #}
            <div class="relative group" id="profile-picture-container">
                {# Preview image (hidden by default) #}
                <img id="profile-picture-preview" src="" alt="Preview"
                     class="w-16 h-16 rounded-full object-cover border-2 border-blackbook-200 shadow-sm hidden">
                {# Placeholder avatar #}
                <div id="profile-picture-placeholder" class="w-16 h-16 rounded-full bg-blackbook-200 flex items-center justify-center border-2 border-blackbook-300">
                    <svg class="w-8 h-8 text-blackbook-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>

                {# Upload overlay #}
                <label class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                    <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="previewProfilePicture(this)">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </label>

                {# Remove button (hidden by default) #}
                <button type="button" id="remove-picture-btn"
                        onclick="removeProfilePicture()"
                        class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full items-center justify-center hidden hover:bg-red-600"
                        title="Remove picture">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div>
                <h1 class="text-2xl font-bold text-blackbook-900">New Person</h1>
                <p id="person-subtitle" class="text-blackbook-500">Add a new contact to your network</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <a href="/people" class="px-4 py-2 text-blackbook-600 hover:text-blackbook-800 font-medium">
                Cancel
            </a>
            <button type="submit"
                    class="px-6 py-2 bg-blackbook-600 text-white font-medium rounded-md hover:bg-blackbook-700 focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:ring-offset-2">
                Create Person
            </button>
        </div>
    </div>

    {# Hidden field for profile picture URL (will be set after upload) #}
    <input type="hidden" name="profile_picture" id="profile-picture-url" value="">

    <!-- Tags Section (Collapsible) -->
    {% call collapsible_section('tags', 'Tags', open=false) %}
        {% if all_tags %}
        <div class="flex flex-wrap gap-3">
            {% for tag in all_tags %}
            <label class="inline-flex items-center cursor-pointer group/tag">
                <input type="checkbox" name="tag_ids" value="{{ tag.id }}"
                       class="h-4 w-4 text-blackbook-600 border-blackbook-300 rounded focus:ring-blackbook-500">
                <span class="ml-2 px-2 py-0.5 text-sm font-medium rounded-full group-hover/tag:opacity-80"
                      style="background-color: {{ tag.color or '#e5e7eb' }}20; color: {{ tag.color or '#374151' }}; border: 1px solid {{ tag.color or '#d1d5db' }};">
                    {{ tag.name }}
                </span>
            </label>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-blackbook-500 italic">No tags available. <a href="/tags/new" class="text-blue-600 hover:underline">Create a tag</a></p>
        {% endif %}
    {% endcall %}

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Main Content Sections -->
        <div class="lg:col-span-2 space-y-4">

            <!-- Name & Basic Info Section -->
            {% call collapsible_section('basic-info', 'Name & Basic Info', open=true) %}
            <div class="space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-blackbook-700 mb-1">First Name</label>
                        <input type="text" name="first_name" id="first_name"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="middle_name" class="block text-sm font-medium text-blackbook-700 mb-1">Middle Name</label>
                        <input type="text" name="middle_name" id="middle_name"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-blackbook-700 mb-1">Last Name</label>
                        <input type="text" name="last_name" id="last_name"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="nickname" class="block text-sm font-medium text-blackbook-700 mb-1">Nickname</label>
                        <input type="text" name="nickname" id="nickname"
                               placeholder="e.g., Alex, Bobby"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                </div>
                <div>
                    <label for="full_name" class="block text-sm font-medium text-blackbook-700 mb-1">Full Name <span class="text-red-500">*</span></label>
                    <input type="text" name="full_name" id="full_name" required
                           placeholder="Auto-fills from name fields, or enter custom"
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    <p class="text-xs text-blackbook-400 mt-1">Will auto-fill from first/middle/last name, or enter a custom display name</p>
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-blackbook-700 mb-1">Title / Role</label>
                    <input type="text" name="title" id="title"
                           placeholder="e.g., CEO, Software Engineer"
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
                <div>
                    <label for="company_name" class="block text-sm font-medium text-blackbook-700 mb-1">Company</label>
                    <input type="text" name="company_name" id="company_name"
                           placeholder="Current company or organization"
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
            </div>
            {% endcall %}

            <!-- Contact Information Section -->
            {% call collapsible_section('contact-info', 'Contact Information', open=true) %}
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-blackbook-700 mb-1">Primary Email</label>
                        <input type="email" name="email" id="email"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-blackbook-700 mb-1">Primary Phone</label>
                        <input type="tel" name="phone" id="phone"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="birthday" class="block text-sm font-medium text-blackbook-700 mb-1">Birthday</label>
                        <input type="date" name="birthday" id="birthday"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-blackbook-700 mb-1">Location</label>
                        <input type="text" name="location" id="location"
                               placeholder="City, State, Country"
                               class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                    </div>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="contacted" id="contacted" value="true"
                           class="h-4 w-4 text-blackbook-600 focus:ring-blackbook-500 border-blackbook-300 rounded">
                    <label for="contacted" class="ml-2 text-sm text-blackbook-700">Already Contacted</label>
                </div>
            </div>
            {% endcall %}

            <!-- Social Profiles Section -->
            {% call collapsible_section('social', 'Social Profiles', open=true) %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="linkedin" class="block text-sm font-medium text-blackbook-700 mb-1">LinkedIn URL</label>
                    <input type="url" name="linkedin" id="linkedin"
                           placeholder="https://linkedin.com/in/..."
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
                <div>
                    <label for="twitter" class="block text-sm font-medium text-blackbook-700 mb-1">Twitter URL</label>
                    <input type="url" name="twitter" id="twitter"
                           placeholder="https://twitter.com/..."
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
                <div>
                    <label for="crunchbase" class="block text-sm font-medium text-blackbook-700 mb-1">Crunchbase URL</label>
                    <input type="url" name="crunchbase" id="crunchbase"
                           placeholder="https://crunchbase.com/person/..."
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
                <div>
                    <label for="angellist" class="block text-sm font-medium text-blackbook-700 mb-1">AngelList URL</label>
                    <input type="url" name="angellist" id="angellist"
                           placeholder="https://angel.co/..."
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
                <div class="md:col-span-2">
                    <label for="website" class="block text-sm font-medium text-blackbook-700 mb-1">Website</label>
                    <input type="url" name="website" id="website"
                           placeholder="https://..."
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
            </div>
            {% endcall %}

            <!-- Investment Details Section -->
            {% call collapsible_section('investment', 'Investment Details', open=false) %}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="investment_type" class="block text-sm font-medium text-blackbook-700 mb-1">Investment Type</label>
                    <input type="text" name="investment_type" id="investment_type"
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
                <div>
                    <label for="amount_funded" class="block text-sm font-medium text-blackbook-700 mb-1">Amount Funded</label>
                    <input type="text" name="amount_funded" id="amount_funded"
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
                <div>
                    <label for="potential_intro_vc" class="block text-sm font-medium text-blackbook-700 mb-1">Potential Intro VC</label>
                    <input type="text" name="potential_intro_vc" id="potential_intro_vc"
                           class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent">
                </div>
            </div>
            {% endcall %}

            <!-- Notes Section -->
            {% call collapsible_section('notes', 'Notes', open=true) %}
            <textarea name="notes" id="notes" rows="4"
                      class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:border-transparent"
                      placeholder="Add any notes about this person..."></textarea>
            {% endcall %}

            <!-- Employment History Section -->
            {% call collapsible_section('employment', 'Employment History', open=false) %}
            <div class="space-y-4">
                <p class="text-blackbook-400 italic text-sm" id="no-employment-msg">No employment history yet</p>

                {# List of added employment entries #}
                <div id="employment-list" class="space-y-3 hidden"></div>

                {# Add Employment Button/Form #}
                <div id="add-employment-form" class="border border-dashed border-blackbook-300 rounded-lg p-4">
                    <button type="button"
                            onclick="toggleNewEmploymentForm()"
                            id="add-employment-btn"
                            class="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Employment
                    </button>

                    <div id="new-employment-form" class="hidden mt-4 space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Organization Name *</label>
                                <input type="text" id="emp-org-name"
                                       placeholder="Company name"
                                       class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Title</label>
                                <input type="text" id="emp-title"
                                       placeholder="Job title"
                                       class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Relationship Type</label>
                                <select id="emp-relationship"
                                        class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                                    <option value="">Select type...</option>
                                    <option value="current_employee">Current Employee</option>
                                    <option value="former_employee">Former Employee</option>
                                    <option value="founder">Founder</option>
                                    <option value="advisor">Advisor</option>
                                    <option value="board_member">Board Member</option>
                                    <option value="investor">Investor</option>
                                </select>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="emp-is-current"
                                           class="w-4 h-4 text-green-600 border-blackbook-300 rounded focus:ring-green-500">
                                    <span class="text-sm text-blackbook-700">Currently works here</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" onclick="toggleNewEmploymentForm()"
                                    class="px-3 py-1.5 text-sm text-blackbook-600 hover:text-blackbook-800">
                                Cancel
                            </button>
                            <button type="button" onclick="addEmploymentEntry()"
                                    class="px-3 py-1.5 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700">
                                Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endcall %}

            <!-- Education Section -->
            {% call collapsible_section('education', 'Education', open=false) %}
            <div class="space-y-4">
                <p class="text-blackbook-400 italic text-sm" id="no-education-msg">No education history yet</p>

                {# List of added education entries #}
                <div id="education-list" class="space-y-3 hidden"></div>

                {# Add Education Button/Form #}
                <div id="add-education-form" class="border border-dashed border-blackbook-300 rounded-lg p-4">
                    <button type="button"
                            onclick="toggleNewEducationForm()"
                            id="add-education-btn"
                            class="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Education
                    </button>

                    <div id="new-education-form" class="hidden mt-4 space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">School Name *</label>
                                <input type="text" id="edu-school-name"
                                       placeholder="University or school name"
                                       class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Degree Type</label>
                                <select id="edu-degree-type"
                                        class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                                    <option value="">Select degree...</option>
                                    <option value="BA">BA - Bachelor of Arts</option>
                                    <option value="BS">BS - Bachelor of Science</option>
                                    <option value="MA">MA - Master of Arts</option>
                                    <option value="MS">MS - Master of Science</option>
                                    <option value="MBA">MBA - Master of Business Administration</option>
                                    <option value="PhD">PhD - Doctor of Philosophy</option>
                                    <option value="JD">JD - Juris Doctor</option>
                                    <option value="MD">MD - Doctor of Medicine</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Field of Study</label>
                                <input type="text" id="edu-field"
                                       placeholder="e.g., Computer Science"
                                       class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Graduation Year</label>
                                <input type="number" id="edu-grad-year"
                                       min="1900" max="2100"
                                       placeholder="e.g., 2020"
                                       class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" onclick="toggleNewEducationForm()"
                                    class="px-3 py-1.5 text-sm text-blackbook-600 hover:text-blackbook-800">
                                Cancel
                            </button>
                            <button type="button" onclick="addEducationEntry()"
                                    class="px-3 py-1.5 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700">
                                Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endcall %}

            <!-- Relationships Section -->
            {% call collapsible_section('relationships', 'Relationships', open=false) %}
            <div class="space-y-4">
                <p class="text-blackbook-400 italic text-sm" id="no-relationships-msg">No relationships yet</p>

                {# List of added relationship entries #}
                <div id="relationships-list" class="space-y-3 hidden"></div>

                {# Add Relationship Button/Form #}
                <div id="add-relationship-form" class="border border-dashed border-blackbook-300 rounded-lg p-4">
                    <button type="button"
                            onclick="toggleNewRelationshipForm()"
                            id="add-relationship-btn"
                            class="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Relationship
                    </button>

                    <div id="new-relationship-form" class="hidden mt-4 space-y-3">
                        <div class="grid grid-cols-1 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Related Person *</label>
                                <select id="rel-person-select"
                                        class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                                    <option value="">Select person...</option>
                                    {% for p in all_persons %}
                                    <option value="{{ p.id }}" data-name="{{ p.full_name }}">{{ p.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Relationship Type</label>
                                <select id="rel-type-select"
                                        class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500">
                                    <option value="">Select type...</option>
                                    {% for rtype in relationship_types %}
                                    <option value="{{ rtype.id }}" data-name="{{ rtype.name }}">{{ rtype.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blackbook-600 mb-1">Context / Notes</label>
                                <textarea id="rel-context" rows="2"
                                          placeholder="e.g., Worked together in 2020"
                                          class="w-full px-3 py-2 text-sm border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500"></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" onclick="toggleNewRelationshipForm()"
                                    class="px-3 py-1.5 text-sm text-blackbook-600 hover:text-blackbook-800">
                                Cancel
                            </button>
                            <button type="button" onclick="addRelationshipEntry()"
                                    class="px-3 py-1.5 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700">
                                Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endcall %}
        </div>

        <!-- Right Column: Info Cards -->
        <div class="space-y-6">
            <!-- Quick Tips Card -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-blue-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Quick Tips</h3>
                        <ul class="mt-2 text-sm text-blue-700 list-disc list-inside space-y-1">
                            <li>Only <strong>Full Name</strong> is required</li>
                            <li>Expand sections to add more details</li>
                            <li>Employment, Education & Relationships will be saved when you create the person</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Additional Info Card -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-blackbook-900 mb-4">After Creation</h2>
                <div class="space-y-3 text-sm text-blackbook-600">
                    <div class="flex items-start space-x-2">
                        <svg class="h-5 w-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Upload a profile picture</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="h-5 w-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Add employment history</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="h-5 w-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Add education background</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="h-5 w-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Connect with other people</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="h-5 w-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Log interactions</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="h-5 w-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Use AI Research to learn more</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// ============ PROFILE PICTURE ============
let selectedProfilePicture = null;

function previewProfilePicture(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Invalid file type. Please select a JPG, PNG, GIF, or WebP image.');
            return;
        }

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('File too large. Maximum size is 5MB.');
            return;
        }

        selectedProfilePicture = file;

        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profile-picture-preview');
            const placeholder = document.getElementById('profile-picture-placeholder');
            const removeBtn = document.getElementById('remove-picture-btn');

            preview.src = e.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            removeBtn.classList.remove('hidden');
            removeBtn.classList.add('flex');
        };
        reader.readAsDataURL(file);
    }
}

function removeProfilePicture() {
    selectedProfilePicture = null;

    const preview = document.getElementById('profile-picture-preview');
    const placeholder = document.getElementById('profile-picture-placeholder');
    const removeBtn = document.getElementById('remove-picture-btn');
    const input = document.getElementById('profile-picture-input');

    preview.src = '';
    preview.classList.add('hidden');
    placeholder.classList.remove('hidden');
    removeBtn.classList.add('hidden');
    removeBtn.classList.remove('flex');
    input.value = '';
}

// Override form submission to upload profile picture first
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('person-form');
    form.addEventListener('htmx:configRequest', async function(e) {
        if (selectedProfilePicture) {
            // Upload the profile picture first
            const formData = new FormData();
            formData.append('file', selectedProfilePicture);

            try {
                // Store in a temporary location - we'll use a special endpoint
                const response = await fetch('/api/people/upload/temp-profile-picture', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('profile-picture-url').value = result.url;
                }
            } catch (error) {
                console.error('Failed to upload profile picture:', error);
            }
        }
    });
});

// Auto-fill full_name from name components
function updateFullName() {
    const firstName = document.getElementById('first_name').value.trim();
    const middleName = document.getElementById('middle_name').value.trim();
    const lastName = document.getElementById('last_name').value.trim();
    const fullNameField = document.getElementById('full_name');

    // Only auto-fill if user hasn't manually edited full_name
    if (!fullNameField.dataset.manuallyEdited) {
        const parts = [firstName, middleName, lastName].filter(p => p);
        fullNameField.value = parts.join(' ');
    }
}

document.getElementById('first_name').addEventListener('input', updateFullName);
document.getElementById('middle_name').addEventListener('input', updateFullName);
document.getElementById('last_name').addEventListener('input', updateFullName);

// Mark full_name as manually edited when user types in it directly
document.getElementById('full_name').addEventListener('input', function() {
    this.dataset.manuallyEdited = 'true';
});

// ============ DYNAMIC SUBTITLE & COMPANY SYNC ============
function updateSubtitle() {
    const title = document.getElementById('title').value.trim();
    const company = document.getElementById('company_name').value.trim();
    const subtitle = document.getElementById('person-subtitle');

    if (title && company) {
        subtitle.textContent = `${title} at ${company}`;
    } else if (title) {
        subtitle.textContent = title;
    } else if (company) {
        subtitle.textContent = `at ${company}`;
    } else {
        subtitle.textContent = 'Add a new contact to your network';
    }
}

// Update subtitle when title or company changes
document.getElementById('title').addEventListener('input', updateSubtitle);
document.getElementById('company_name').addEventListener('input', function() {
    updateSubtitle();
    syncPrimaryEmployment();
});

// Sync company field to a "primary" employment entry
function syncPrimaryEmployment() {
    const company = document.getElementById('company_name').value.trim();
    const title = document.getElementById('title').value.trim();
    const list = document.getElementById('employment-list');
    const noMsg = document.getElementById('no-employment-msg');

    // Look for existing primary employment entry
    let primaryEntry = document.getElementById('primary-employment-entry');

    if (!company) {
        // Remove primary entry if company is cleared
        if (primaryEntry) {
            primaryEntry.remove();
            if (list.children.length === 0) {
                list.classList.add('hidden');
                noMsg.classList.remove('hidden');
            }
        }
        return;
    }

    if (primaryEntry) {
        // Update existing primary entry
        primaryEntry.querySelector('.emp-org-display').textContent = company;
        primaryEntry.querySelector('.emp-title-display').textContent = title || '';
        primaryEntry.querySelector('input[name*="organization_name"]').value = company;
        primaryEntry.querySelector('input[name*="title"]').value = title;
    } else {
        // Create new primary employment entry
        const entry = document.createElement('div');
        entry.id = 'primary-employment-entry';
        entry.className = 'flex items-start justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-300 dark:border-green-700';
        entry.innerHTML = `
            <div class="flex-1">
                <div class="font-medium text-blackbook-900 dark:text-white emp-org-display">${company}</div>
                <div class="text-sm text-blackbook-600 dark:text-blackbook-300 emp-title-display">${title}</div>
                <div class="flex items-center gap-2 mt-1 flex-wrap">
                    <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">Employee</span>
                    <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300">Current</span>
                    <span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300">Synced from above</span>
                </div>
            </div>
            <input type="hidden" name="employment[primary][organization_name]" value="${company}">
            <input type="hidden" name="employment[primary][title]" value="${title}">
            <input type="hidden" name="employment[primary][relationship]" value="current_employee">
            <input type="hidden" name="employment[primary][is_current]" value="true">
        `;

        // Insert at the beginning of the list
        list.insertBefore(entry, list.firstChild);
        list.classList.remove('hidden');
        noMsg.classList.add('hidden');
    }
}

// Also update primary employment when title changes
document.getElementById('title').addEventListener('input', function() {
    if (document.getElementById('company_name').value.trim()) {
        syncPrimaryEmployment();
    }
});

// ============ EMPLOYMENT ============
let employmentCounter = 0;

function toggleNewEmploymentForm() {
    const form = document.getElementById('new-employment-form');
    const btn = document.getElementById('add-employment-btn');
    form.classList.toggle('hidden');
    btn.classList.toggle('hidden');
}

function addEmploymentEntry() {
    const orgName = document.getElementById('emp-org-name').value.trim();
    const title = document.getElementById('emp-title').value.trim();
    const relationship = document.getElementById('emp-relationship').value;
    const relationshipText = document.getElementById('emp-relationship').selectedOptions[0]?.text || '';
    const isCurrent = document.getElementById('emp-is-current').checked;

    if (!orgName) {
        alert('Please enter an organization name');
        return;
    }

    const list = document.getElementById('employment-list');
    const noMsg = document.getElementById('no-employment-msg');

    // Create entry element
    const entry = document.createElement('div');
    entry.className = 'flex items-start justify-between p-3 bg-blackbook-50 dark:bg-blackbook-700/50 rounded-lg border ' + (isCurrent ? 'border-green-300 dark:border-green-700' : 'border-blackbook-200 dark:border-blackbook-600');
    entry.innerHTML = `
        <div class="flex-1">
            <div class="font-medium text-blackbook-900 dark:text-white">${orgName}</div>
            ${title ? `<div class="text-sm text-blackbook-600 dark:text-blackbook-300">${title}</div>` : ''}
            <div class="flex items-center gap-2 mt-1 flex-wrap">
                ${relationshipText ? `<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">${relationshipText}</span>` : ''}
                <span class="px-2 py-0.5 text-xs rounded-full ${isCurrent ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300'}">${isCurrent ? 'Current' : 'Past'}</span>
            </div>
        </div>
        <button type="button" onclick="removeEmploymentEntry(this)" class="p-1 text-blackbook-400 hover:text-red-600" title="Remove">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
        </button>
        <input type="hidden" name="employment[${employmentCounter}][organization_name]" value="${orgName}">
        <input type="hidden" name="employment[${employmentCounter}][title]" value="${title}">
        <input type="hidden" name="employment[${employmentCounter}][relationship]" value="${relationship}">
        <input type="hidden" name="employment[${employmentCounter}][is_current]" value="${isCurrent}">
    `;

    list.appendChild(entry);
    list.classList.remove('hidden');
    noMsg.classList.add('hidden');
    employmentCounter++;

    // Reset form
    document.getElementById('emp-org-name').value = '';
    document.getElementById('emp-title').value = '';
    document.getElementById('emp-relationship').value = '';
    document.getElementById('emp-is-current').checked = false;
    toggleNewEmploymentForm();
}

function removeEmploymentEntry(btn) {
    const entry = btn.closest('.flex');
    entry.remove();

    const list = document.getElementById('employment-list');
    if (list.children.length === 0) {
        list.classList.add('hidden');
        document.getElementById('no-employment-msg').classList.remove('hidden');
    }
}

// ============ EDUCATION ============
let educationCounter = 0;

function toggleNewEducationForm() {
    const form = document.getElementById('new-education-form');
    const btn = document.getElementById('add-education-btn');
    form.classList.toggle('hidden');
    btn.classList.toggle('hidden');
}

function addEducationEntry() {
    const schoolName = document.getElementById('edu-school-name').value.trim();
    const degreeType = document.getElementById('edu-degree-type').value;
    const degreeText = document.getElementById('edu-degree-type').selectedOptions[0]?.text || '';
    const field = document.getElementById('edu-field').value.trim();
    const gradYear = document.getElementById('edu-grad-year').value;

    if (!schoolName) {
        alert('Please enter a school name');
        return;
    }

    const list = document.getElementById('education-list');
    const noMsg = document.getElementById('no-education-msg');

    // Create entry element
    const entry = document.createElement('div');
    entry.className = 'flex items-start justify-between p-3 bg-blackbook-700 rounded-lg border border-blackbook-600';
    entry.innerHTML = `
        <div class="flex-1">
            <div class="font-medium text-white">${schoolName}</div>
            ${degreeType || field ? `<div class="text-sm text-blackbook-300">${degreeType || ''}${degreeType && field ? ' in ' : ''}${field || ''}</div>` : ''}
            ${gradYear ? `<div class="text-xs text-blackbook-400 mt-1">Class of ${gradYear}</div>` : ''}
        </div>
        <button type="button" onclick="removeEducationEntry(this)" class="p-1 text-blackbook-400 hover:text-red-600" title="Remove">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
        </button>
        <input type="hidden" name="education[${educationCounter}][school_name]" value="${schoolName}">
        <input type="hidden" name="education[${educationCounter}][degree_type]" value="${degreeType}">
        <input type="hidden" name="education[${educationCounter}][field_of_study]" value="${field}">
        <input type="hidden" name="education[${educationCounter}][graduation_year]" value="${gradYear}">
    `;

    list.appendChild(entry);
    list.classList.remove('hidden');
    noMsg.classList.add('hidden');
    educationCounter++;

    // Reset form
    document.getElementById('edu-school-name').value = '';
    document.getElementById('edu-degree-type').value = '';
    document.getElementById('edu-field').value = '';
    document.getElementById('edu-grad-year').value = '';
    toggleNewEducationForm();
}

function removeEducationEntry(btn) {
    const entry = btn.closest('.flex');
    entry.remove();

    const list = document.getElementById('education-list');
    if (list.children.length === 0) {
        list.classList.add('hidden');
        document.getElementById('no-education-msg').classList.remove('hidden');
    }
}

// ============ RELATIONSHIPS ============
let relationshipCounter = 0;

function toggleNewRelationshipForm() {
    const form = document.getElementById('new-relationship-form');
    const btn = document.getElementById('add-relationship-btn');
    form.classList.toggle('hidden');
    btn.classList.toggle('hidden');
}

function addRelationshipEntry() {
    const personSelect = document.getElementById('rel-person-select');
    const personId = personSelect.value;
    const personName = personSelect.selectedOptions[0]?.dataset.name || personSelect.selectedOptions[0]?.text || '';
    const typeSelect = document.getElementById('rel-type-select');
    const typeId = typeSelect.value;
    const typeName = typeSelect.selectedOptions[0]?.dataset.name || typeSelect.selectedOptions[0]?.text || '';
    const context = document.getElementById('rel-context').value.trim();

    if (!personId) {
        alert('Please select a person');
        return;
    }

    const list = document.getElementById('relationships-list');
    const noMsg = document.getElementById('no-relationships-msg');

    // Create entry element
    const entry = document.createElement('div');
    entry.className = 'flex items-center justify-between p-3 bg-blackbook-50 rounded-lg border border-blackbook-200';
    entry.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-blackbook-200 flex items-center justify-center">
                <span class="text-sm font-medium text-blackbook-600">${personName.charAt(0).toUpperCase()}</span>
            </div>
            <div>
                <span class="font-medium text-blackbook-900">${personName}</span>
                ${typeName ? `<div class="text-xs text-blackbook-500">${typeName}</div>` : ''}
            </div>
        </div>
        <button type="button" onclick="removeRelationshipEntry(this)" class="p-1 text-blackbook-400 hover:text-red-600" title="Remove">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
        </button>
        <input type="hidden" name="relationships[${relationshipCounter}][related_person_id]" value="${personId}">
        <input type="hidden" name="relationships[${relationshipCounter}][relationship_type_id]" value="${typeId}">
        <input type="hidden" name="relationships[${relationshipCounter}][context_text]" value="${context}">
    `;

    list.appendChild(entry);
    list.classList.remove('hidden');
    noMsg.classList.add('hidden');
    relationshipCounter++;

    // Reset form
    personSelect.value = '';
    typeSelect.value = '';
    document.getElementById('rel-context').value = '';
    toggleNewRelationshipForm();
}

function removeRelationshipEntry(btn) {
    const entry = btn.closest('.flex');
    entry.remove();

    const list = document.getElementById('relationships-list');
    if (list.children.length === 0) {
        list.classList.add('hidden');
        document.getElementById('no-relationships-msg').classList.remove('hidden');
    }
}
</script>
{% endblock %}
