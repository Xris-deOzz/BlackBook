{% extends "base.html" %}

{% block head %}
<style>
    /* Custom styles for sort indicators */
    .sort-indicator::after {
        content: '';
        margin-left: 0.25rem;
    }
    .sort-asc::after {
        content: ' \2191';
    }
    .sort-desc::after {
        content: ' \2193';
    }
    /* Tom Select customization */
    .ts-wrapper.multi .ts-control {
        padding: 4px 8px;
    }
    .ts-wrapper .ts-control {
        border-color: rgb(209, 213, 219);
        border-radius: 0.375rem;
    }
    .ts-wrapper.focus .ts-control {
        border-color: rgb(59, 130, 246);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-blackbook-900">People</h1>
            <p class="text-sm text-blackbook-500">{{ total_count }} total records</p>
        </div>
        <a href="/people/new"
           class="inline-flex items-center px-4 py-2 bg-blackbook-600 text-white font-medium rounded-md hover:bg-blackbook-700 focus:outline-none focus:ring-2 focus:ring-blackbook-500 focus:ring-offset-2">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            New Person
        </a>
    </div>

    <!-- Filters Bar -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <form id="filter-form" class="space-y-4">
            <!-- Row 1: Search, Per Page, Clear Filters, Save View -->
            <div class="flex flex-wrap gap-4 items-end">
                <!-- Search Input -->
                <div class="flex-1 min-w-[200px]">
                    <label for="search" class="block text-sm font-medium text-blackbook-700 mb-1">
                        Search
                    </label>
                    <input
                        type="search"
                        id="search"
                        name="q"
                        value="{{ q }}"
                        placeholder="Search name, title, email, notes..."
                        class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500"
                        hx-get="/people/table"
                        hx-trigger="input changed delay:300ms, search"
                        hx-target="#person-table-container"
                        hx-include="#filter-form"
                    >
                </div>

                <!-- Per Page Selector -->
                <div class="w-32">
                    <label for="per_page" class="block text-sm font-medium text-blackbook-700 mb-1">
                        Per Page
                    </label>
                    <select
                        id="per_page"
                        name="per_page"
                        class="w-full px-3 py-2 border border-blackbook-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blackbook-500"
                        onchange="changePerPage(this.value)"
                    >
                        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        <option value="250" {% if per_page == 250 %}selected{% endif %}>250</option>
                    </select>
                </div>

                <!-- Clear Filters Button -->
                <div class="flex items-end">
                    <a
                        href="/people"
                        class="px-4 py-2 text-sm bg-blackbook-100 text-blackbook-700 rounded-md hover:bg-blackbook-200 inline-flex items-center h-[42px]"
                    >
                        Clear Filters
                    </a>
                </div>

                <!-- Save View Button -->
                <div class="flex items-end">
                    <button
                        type="button"
                        onclick="saveCurrentView()"
                        class="px-4 py-2 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700 inline-flex items-center gap-1 h-[42px]"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                        </svg>
                        Save View
                    </button>
                </div>
            </div>

            <!-- Row 2: Tags Filter with AND/OR toggle -->
            <div class="flex flex-wrap gap-4 items-end border-t border-blackbook-200 pt-4">
                <!-- Multi-Tag Filter -->
                <div class="flex-1 min-w-[300px]">
                    <label for="tag_ids" class="block text-sm font-medium text-blackbook-700 mb-1">
                        Tags
                    </label>
                    <select
                        id="tag_ids"
                        name="tag_ids"
                        multiple
                        placeholder="Select tags to filter..."
                        class="w-full"
                    >
                        {% for tag in all_tags %}
                        <option value="{{ tag.id }}" {% if tag.id|string in selected_tag_ids %}selected{% endif %}>
                            {{ tag.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Tag Logic Toggle (AND/OR) -->
                <div class="flex items-end">
                    <input type="hidden" name="tag_logic" id="tag_logic" value="{{ tag_logic|default('or') }}">
                    <button
                        type="button"
                        id="tag-logic-toggle"
                        onclick="toggleTagLogic()"
                        class="px-4 py-2 text-sm font-medium rounded-md h-[42px] min-w-[80px] {% if tag_logic == 'and' %}bg-blue-600 text-white{% else %}bg-blackbook-500 text-white{% endif %}"
                        title="Toggle between AND (all tags required) and OR (any tag matches)"
                    >
                        {{ tag_logic|default('or')|upper }}
                    </button>
                </div>

                <!-- Go Button for Tags -->
                <div class="flex items-end">
                    <button
                        type="button"
                        onclick="applyTagFilter()"
                        class="px-4 py-2 text-sm bg-blackbook-600 text-white rounded-md hover:bg-blackbook-700 h-[42px]"
                    >
                        Go
                    </button>
                </div>
            </div>

            <!-- Hidden inputs for sort state -->
            <input type="hidden" name="sort_by" id="sort_by" value="{{ sort_by }}">
            <input type="hidden" name="sort_order" id="sort_order" value="{{ sort_order }}">
            <input type="hidden" name="letter" id="letter" value="{{ letter }}">
            <input type="hidden" name="page" id="page" value="1">
        </form>
    </div>

    <!-- Alphabet Navigation -->
    <div class="bg-white rounded-lg shadow-md p-3">
        <div class="flex flex-wrap items-center gap-1">
            <span class="text-sm font-medium text-blackbook-600 mr-2">Filter by Last Name:</span>
            <button
                onclick="filterByLetter('')"
                class="px-2 py-1 text-sm rounded {% if not letter %}bg-blackbook-600 text-white{% else %}bg-blackbook-100 text-blackbook-700 hover:bg-blackbook-200{% endif %}"
            >
                All
            </button>
            {% for l in 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %}
            <button
                onclick="filterByLetter('{{ l }}')"
                class="w-8 h-8 text-sm rounded {% if letter == l %}bg-blackbook-600 text-white{% else %}bg-blackbook-100 text-blackbook-700 hover:bg-blackbook-200{% endif %}"
            >
                {{ l }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Table Container -->
    <div id="person-table-container">
        {% include "persons/_table.html" %}
    </div>
</div>

<script>
    // Tom Select instance for tags
    let tagSelect;

    // Initialize Tom Select for multi-tag selection
    document.addEventListener('DOMContentLoaded', function() {
        tagSelect = new TomSelect('#tag_ids', {
            plugins: ['remove_button'],
            maxItems: null,
            placeholder: 'Select tags to filter...',
            allowEmptyOption: true,
            hidePlaceholder: false,
        });

        // Initialize resizable columns
        initResizableTable('person-table', 'person-table-widths');
    });

    // Get selected tag IDs from Tom Select
    function getSelectedTagIds() {
        if (tagSelect) {
            return tagSelect.getValue();
        }
        return [];
    }

    // Apply tag filter - navigate with selected tags
    function applyTagFilter() {
        let params = new URLSearchParams();

        const q = document.getElementById('search').value;
        if (q) params.set('q', q);

        const tagIds = getSelectedTagIds();
        if (tagIds.length > 0) {
            params.set('tag_ids', tagIds.join(','));
        }

        const tagLogic = document.getElementById('tag_logic').value;
        if (tagLogic) params.set('tag_logic', tagLogic);

        const letter = document.getElementById('letter').value;
        if (letter) params.set('letter', letter);

        params.set('sort_by', document.getElementById('sort_by').value);
        params.set('sort_order', document.getElementById('sort_order').value);
        params.set('per_page', document.getElementById('per_page').value);

        window.location.href = '/people?' + params.toString();
    }

    // Toggle AND/OR tag logic
    function toggleTagLogic() {
        const input = document.getElementById('tag_logic');
        const button = document.getElementById('tag-logic-toggle');

        if (input.value === 'or') {
            input.value = 'and';
            button.textContent = 'AND';
            button.classList.remove('bg-blackbook-500');
            button.classList.add('bg-blue-600');
        } else {
            input.value = 'or';
            button.textContent = 'OR';
            button.classList.remove('bg-blue-600');
            button.classList.add('bg-blackbook-500');
        }
    }

    // Filter by letter - navigates to full page with letter filter
    function filterByLetter(letter) {
        let params = new URLSearchParams();

        const q = document.getElementById('search').value;
        if (q) params.set('q', q);

        const tagIds = getSelectedTagIds();
        if (tagIds.length > 0) {
            params.set('tag_ids', tagIds.join(','));
        }

        const tagLogic = document.getElementById('tag_logic').value;
        if (tagLogic) params.set('tag_logic', tagLogic);

        if (letter) params.set('letter', letter);

        params.set('sort_by', document.getElementById('sort_by').value);
        params.set('sort_order', document.getElementById('sort_order').value);
        params.set('per_page', document.getElementById('per_page').value);

        window.location.href = '/people?' + params.toString();
    }

    // Handle per page change with proper URL building (excludes empty params)
    function changePerPage(perPage) {
        let params = new URLSearchParams();
        params.set('per_page', perPage);

        const q = document.getElementById('search').value;
        if (q) params.set('q', q);

        const tagIds = getSelectedTagIds();
        if (tagIds.length > 0) {
            params.set('tag_ids', tagIds.join(','));
        }

        const tagLogic = document.getElementById('tag_logic').value;
        if (tagLogic) params.set('tag_logic', tagLogic);

        const letter = document.getElementById('letter').value;
        if (letter) params.set('letter', letter);

        params.set('sort_by', document.getElementById('sort_by').value);
        params.set('sort_order', document.getElementById('sort_order').value);

        window.location.href = '/people?' + params.toString();
    }

    // Handle sort column clicks
    function sortBy(column) {
        const sortByInput = document.getElementById('sort_by');
        const sortOrderInput = document.getElementById('sort_order');
        const pageInput = document.getElementById('page');

        if (sortByInput.value === column) {
            // Toggle sort order
            sortOrderInput.value = sortOrderInput.value === 'asc' ? 'desc' : 'asc';
        } else {
            // New column, default to ascending
            sortByInput.value = column;
            sortOrderInput.value = 'asc';
        }

        // Reset to page 1 when sorting changes
        pageInput.value = '1';

        // Trigger HTMX request
        htmx.trigger('#search', 'search');
    }

    // Navigate to save view form with current filters
    function saveCurrentView() {
        let params = new URLSearchParams();
        params.set('entity_type', 'person');

        const q = document.getElementById('search').value;
        if (q) params.set('q', q);

        const tagIds = getSelectedTagIds();
        if (tagIds.length > 0) {
            params.set('tag_ids', tagIds.join(','));
        }

        const tagLogic = document.getElementById('tag_logic').value;
        if (tagLogic) params.set('tag_logic', tagLogic);

        const letter = document.getElementById('letter').value;
        if (letter) params.set('letter', letter);

        const sortBy = document.getElementById('sort_by').value;
        if (sortBy) params.set('sort_by', sortBy);

        params.set('sort_order', document.getElementById('sort_order').value);

        window.location.href = '/views/new?' + params.toString();
    }

    // ===========================
    // Selection Management
    // ===========================

    // Toggle all checkboxes
    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.person-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
        updateSelectionUI();
    }

    // Update selection UI (show/hide action bar, update count)
    function updateSelectionUI() {
        const checkboxes = document.querySelectorAll('.person-checkbox');
        const selectedCount = document.querySelectorAll('.person-checkbox:checked').length;
        const selectAllCheckbox = document.getElementById('select-all');
        const actionsBar = document.getElementById('selection-actions');
        const countSpan = document.getElementById('selected-count');

        // Update count
        if (countSpan) countSpan.textContent = selectedCount;

        // Show/hide actions bar
        if (actionsBar) {
            if (selectedCount > 0) {
                actionsBar.classList.remove('hidden');
            } else {
                actionsBar.classList.add('hidden');
            }
        }

        // Update select-all checkbox state
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = selectedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
        }
    }

    // Clear all selections
    function clearSelection() {
        const checkboxes = document.querySelectorAll('.person-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        const selectAllCheckbox = document.getElementById('select-all');
        if (selectAllCheckbox) selectAllCheckbox.checked = false;
        updateSelectionUI();
    }

    // Get selected person IDs
    function getSelectedIds() {
        const checkboxes = document.querySelectorAll('.person-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.dataset.personId);
    }

    // Delete selected people
    async function deleteSelected() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;

        const message = ids.length === 1
            ? 'Are you sure you want to delete this person?'
            : `Are you sure you want to delete ${ids.length} people?`;

        if (!confirm(message)) return;

        try {
            const response = await fetch('/people/batch/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids })
            });

            if (response.ok) {
                // Refresh the table
                htmx.trigger('#search', 'search');
            } else {
                const data = await response.json();
                alert(data.detail || 'Failed to delete people');
            }
        } catch (error) {
            console.error('Error deleting people:', error);
            alert('An error occurred while deleting people');
        }
    }

    // Merge selected people
    async function mergeSelected() {
        const ids = getSelectedIds();
        if (ids.length < 2) {
            alert('Please select at least 2 people to merge');
            return;
        }

        // Navigate to merge page with selected IDs
        const params = new URLSearchParams();
        ids.forEach(id => params.append('ids', id));
        window.location.href = '/people/merge?' + params.toString();
    }

    // Email selected people (opens Gmail with BCC for privacy)
    function emailSelected() {
        const checkboxes = document.querySelectorAll('.person-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one person');
            return;
        }

        // Collect email addresses from selected checkboxes
        const emails = [];
        checkboxes.forEach(cb => {
            const email = cb.dataset.email;
            if (email && email.trim()) {
                emails.push(email.trim());
            }
        });

        if (emails.length === 0) {
            alert('None of the selected contacts have email addresses.');
            return;
        }

        // Build Gmail compose URL with account chooser (BCC for privacy when sending to multiple recipients)
        const bccList = emails.join(',');
        const gmailComposeUrl = `https://mail.google.com/mail/?view=cm&fs=1&bcc=${encodeURIComponent(bccList)}`;
        const url = `https://accounts.google.com/AccountChooser?continue=${encodeURIComponent(gmailComposeUrl)}`;

        // Open in new tab
        window.open(url, '_blank');
    }

    // Re-apply selection UI after HTMX swaps (in case table is refreshed)
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.target.id === 'person-table-container') {
            updateSelectionUI();
        }
    });

    // Open batch tags modal
    function openBatchTagsModal() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            alert('Please select at least one person');
            return;
        }

        // Fetch modal content via HTMX
        htmx.ajax('GET', '/people/batch/tags/modal', {
            target: '#batch-tags-modal-container',
            swap: 'innerHTML'
        });
    }
</script>
{% endblock %}
